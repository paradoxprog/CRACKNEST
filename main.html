<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrackNest | Student Dashboard</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // Indigo 600
                        secondary: '#F59E0B', // Amber 500
                        dark: '#0F172A', // Slate 900
                        light: '#F8FAFC', // Slate 50
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Custom Styles -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        .heading { font-family: 'Poppins', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4F46E5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media print {
            body * { visibility: hidden; }
            #resume-preview, #resume-preview * { visibility: visible; }
            #resume-preview { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; border: none; box-shadow: none; }
        }
        .message-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Graph Bars */
        .bar-container { display: flex; align-items: flex-end; justify-content: space-around; height: 120px; gap: 8px; padding-top: 20px; }
        .bar { width: 100%; background: #4F46E5; border-radius: 4px 4px 0 0; transition: height 0.5s ease; position: relative; min-width: 20px; }
        .bar:hover { opacity: 0.8; }
        .bar:hover::after { content: attr(data-score) '%'; position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; z-index: 10; white-space: nowrap; }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700 heading">Loading CrackNest...</h2>
        <p class="text-slate-500 text-sm mt-2">Initializing Local Environment</p>
        <p id="loading-error" class="text-red-500 mt-2 text-sm hidden"></p>
    </div>

    <!-- MAIN APP LAYOUT (Hidden initially) -->
    <div id="app-container" class="flex h-full hidden">
        
        <!-- SIDEBAR -->
        <aside class="w-64 bg-slate-900 text-white flex-col hidden md:flex transition-all duration-300" id="sidebar">
            <div class="p-6 border-b border-slate-700 flex items-center gap-3">
                <img src="logo.jpg" alt="Logo" class="w-8 h-8 object-contain">
                <span class="text-xl font-bold heading">CrackNest</span>
            </div>

            <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
                <button onclick="navTo('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition text-slate-300 hover:text-white" data-target="dashboard">
                    <i class="fa-solid fa-chart-pie w-6"></i> Dashboard
                </button>
                <button onclick="navTo('training')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition text-slate-300 hover:text-white" data-target="training">
                    <i class="fa-solid fa-book-open w-6"></i> Training Hub
                </button>
                <button onclick="navTo('tests')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition text-slate-300 hover:text-white" data-target="tests">
                    <i class="fa-solid fa-list-check w-6"></i> Test Series
                </button>
                <button onclick="navTo('interview')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition text-slate-300 hover:text-white" data-target="interview">
                    <i class="fa-solid fa-robot w-6"></i> AI Interview
                </button>
                <button onclick="navTo('setup', true)" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition text-slate-300 hover:text-white" data-target="setup">
                    <i class="fa-solid fa-user-pen w-6"></i> My Profile
                </button>
                <button onclick="navTo('resume')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition text-slate-300 hover:text-white" data-target="resume">
                    <i class="fa-solid fa-file-pdf w-6"></i> Resume Builder
                </button>
            </nav>

            <div class="p-4 border-t border-slate-700">
                <div class="flex items-center gap-3 mb-4 cursor-default">
                    <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold" id="sidebar-avatar">U</div>
                    <div>
                        <p class="text-sm font-bold text-white truncate w-32" id="sidebar-name">Student</p>
                        <p class="text-xs text-slate-400" id="sidebar-role">Student</p>
                    </div>
                </div>
                <button id="logout-btn" class="w-full bg-slate-800 hover:bg-red-600/20 text-slate-300 hover:text-red-400 py-2 rounded-lg text-sm transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-right-from-bracket"></i> Sign Out
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 flex flex-col h-full bg-slate-50 relative">
            
            <!-- Mobile Header -->
            <header id="mobile-header" class="bg-white h-16 border-b border-slate-200 flex items-center justify-between px-4 md:hidden shrink-0">
                <div class="flex items-center gap-2">
                    <img src="logo.jpg" alt="Logo" class="w-8 h-8 object-contain">
                    <span class="font-bold text-slate-800">CrackNest</span>
                </div>
                <button class="text-slate-600" onclick="document.getElementById('sidebar').classList.toggle('hidden'); document.getElementById('sidebar').classList.toggle('absolute'); document.getElementById('sidebar').classList.toggle('z-50'); document.getElementById('sidebar').classList.toggle('h-full');">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
            </header>

            <!-- DYNAMIC VIEWS -->
            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 relative">

                <!-- 1. PROFILE SETUP / EDIT VIEW -->
                <div id="view-profile-setup" class="view-section hidden max-w-2xl mx-auto">
                    <div class="bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-indigo-100 text-primary rounded-full flex items-center justify-center text-2xl mx-auto mb-4">
                                <i class="fa-solid fa-user-gear"></i>
                            </div>
                            <h2 class="text-2xl font-bold heading text-slate-900" id="profile-title">Setup Your Profile</h2>
                            <p class="text-slate-500">We need this to personalize your AI training.</p>
                        </div>
                        
                        <form id="profile-form" class="space-y-6">
                            <!-- Personal Info -->
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                                    <input type="text" id="p-name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 outline-none" placeholder="John Doe">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Degree / Stream</label>
                                    <input type="text" id="p-degree" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 outline-none" placeholder="B.Tech CSE">
                                </div>
                            </div>

                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Year of Passing</label>
                                    <input type="number" id="p-year" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 outline-none" placeholder="2025">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Experience Level</label>
                                    <select id="p-exp" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 outline-none">
                                        <option value="Fresher">Fresher (Student)</option>
                                        <option value="Experienced">Experienced (1-3 yrs)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Career Target -->
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Career Field</label>
                                    <select id="p-field" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 outline-none">
                                        <option value="IT">IT / Software</option>
                                        <option value="Marketing">Marketing</option>
                                        <option value="HR">Human Resources</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Engineering">Core Engineering</option>
                                        <option value="Accounting">Accounting / CA</option>
                                        <option value="Data">Data Science</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Specific Role</label>
                                    <input type="text" id="p-role" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 outline-none" placeholder="e.g. Software Developer">
                                </div>
                            </div>
                            
                            <!-- Skills & Certs -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Certifications (if any)</label>
                                <input type="text" id="p-certs" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 outline-none" placeholder="AWS, PMP, etc.">
                            </div>

                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Languages Known</label>
                                    <input type="text" id="p-langs" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 outline-none" placeholder="English, Hindi...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Top Skills</label>
                                    <input type="text" id="p-skills" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 outline-none" placeholder="Java, Python, SQL...">
                                </div>
                            </div>

                            <button type="submit" id="save-profile-btn" class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/30">
                                Save & Start Baseline Test
                            </button>
                        </form>
                    </div>
                </div>

                <!-- 2. BASELINE TEST VIEW -->
                <div id="view-baseline-test" class="view-section hidden max-w-3xl mx-auto">
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div class="bg-indigo-600 p-6 text-white text-center">
                            <h2 class="text-2xl font-bold heading">Baseline Skill Assessment</h2>
                            <p class="text-indigo-200 text-sm">Let's find your starting point.</p>
                        </div>
                        <div class="p-8">
                            <div id="quiz-container">
                                <div class="mb-6">
                                    <span class="text-xs font-bold text-primary uppercase tracking-wide">Question <span id="q-current">1</span> of <span id="q-total">10</span></span>
                                    <h3 class="text-lg font-medium text-slate-900 mt-2" id="q-text">Question text goes here?</h3>
                                </div>
                                <div class="space-y-3" id="q-options">
                                    <!-- Options injected here -->
                                </div>
                            </div>
                            <div id="quiz-results" class="hidden text-center space-y-6">
                                <div class="w-24 h-24 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-4xl mx-auto">
                                    <i class="fa-solid fa-check"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-slate-900">Assessment Complete!</h3>
                                    <p class="text-slate-600">Your custom roadmap is ready.</p>
                                </div>
                                <div class="grid grid-cols-3 gap-4 text-center max-w-sm mx-auto">
                                    <div class="p-3 bg-slate-50 rounded-lg">
                                        <div class="text-xl font-bold text-primary" id="res-score">0%</div>
                                        <div class="text-xs text-slate-500">Score</div>
                                    </div>
                                    <div class="p-3 bg-slate-50 rounded-lg">
                                        <div class="text-xl font-bold text-secondary" id="res-level">Beginner</div>
                                        <div class="text-xs text-slate-500">Level</div>
                                    </div>
                                    <div class="p-3 bg-slate-50 rounded-lg">
                                        <div class="text-xl font-bold text-green-600">Yes</div>
                                        <div class="text-xs text-slate-500">Roadmap</div>
                                    </div>
                                </div>
                                <button onclick="finishBaseline()" class="px-8 py-3 bg-primary text-white rounded-lg font-bold hover:bg-indigo-700 transition">Go to Dashboard</button>
                            </div>
                        </div>
                        <div class="px-8 py-4 bg-slate-50 border-t flex justify-between items-center" id="quiz-footer">
                            <div class="w-full bg-slate-200 h-2 rounded-full mr-4">
                                <div id="quiz-progress" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <button id="next-q-btn" class="bg-slate-900 text-white px-6 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 disabled:opacity-50">Next</button>
                        </div>
                    </div>
                </div>

                <!-- 3. DASHBOARD VIEW -->
                <div id="view-dashboard" class="view-section hidden space-y-8">
                    <!-- Welcome Header -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold heading text-slate-900">Welcome, <span id="dash-name" class="text-primary">Student</span>! ðŸ‘‹</h1>
                            <p class="text-slate-500">Here's your progress for today.</p>
                        </div>
                        <div class="flex gap-3">
                            <span class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-semibold text-slate-600 shadow-sm">
                                <i class="fa-solid fa-fire text-orange-500 mr-2"></i> <span id="dash-streak">3</span> Day Streak
                            </span>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-bold text-slate-700">Interview Readiness</h3>
                                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600"><i class="fa-solid fa-battery-full"></i></div>
                            </div>
                            <div class="text-3xl font-bold text-slate-900 mb-2" id="dash-readiness">0%</div>
                            <div class="w-full bg-slate-100 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: 0%" id="dash-readiness-bar"></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-bold text-slate-700">Modules Completed</h3>
                                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i class="fa-solid fa-list-check"></i></div>
                            </div>
                            <div class="text-3xl font-bold text-slate-900 mb-2"><span id="dash-modules">0</span><span class="text-base text-slate-400 font-normal">/12</span></div>
                            <p class="text-xs text-slate-500">Keep pushing!</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-bold text-slate-700">Target Role</h3>
                                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600"><i class="fa-solid fa-crosshairs"></i></div>
                            </div>
                            <div class="text-xl font-bold text-slate-900 mb-2 truncate" id="dash-role">Not Set</div>
                            <div class="inline-block px-2 py-1 bg-indigo-50 text-primary text-xs font-bold rounded" id="dash-path">Career Path</div>
                        </div>
                    </div>

                    <!-- Recommended Actions & Graph -->
                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- Next Steps -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                            <h3 class="font-bold text-lg mb-4 heading">Recommended for You</h3>
                            <div class="space-y-4">
                                <div class="flex items-center gap-4 p-4 rounded-lg bg-indigo-50 border border-indigo-100 cursor-pointer hover:bg-indigo-100 transition" onclick="navTo('interview')">
                                    <div class="w-10 h-10 rounded-lg bg-indigo-600 text-white flex items-center justify-center"><i class="fa-solid fa-robot"></i></div>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-slate-800">Practice Role Interview</h4>
                                        <p class="text-xs text-slate-500">AI Mock Interview â€¢ 5 mins</p>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-indigo-400"></i>
                                </div>
                                <div class="flex items-center gap-4 p-4 rounded-lg bg-white border border-slate-100 cursor-pointer hover:bg-slate-50 transition" onclick="navTo('training')">
                                    <div class="w-10 h-10 rounded-lg bg-orange-500 text-white flex items-center justify-center"><i class="fa-solid fa-calculator"></i></div>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-slate-800">Technical Concepts</h4>
                                        <p class="text-xs text-slate-500">AI Training â€¢ 15 mins</p>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-slate-300"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Graph -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-slate-700">Performance Analytics</h3>
                                <i class="fa-solid fa-chart-simple text-slate-300"></i>
                            </div>
                            <div class="flex-1 flex flex-col justify-end" id="dash-graph-container">
                                <div class="text-center py-8 text-slate-400 text-sm" id="empty-graph-msg">
                                    <p>Take tests to unlock analytics.</p>
                                </div>
                                <div class="bar-container hidden" id="score-bars">
                                    <!-- Bars injected via JS -->
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-50 flex justify-between text-xs text-slate-400">
                                <span>Recent Tests</span>
                                <span>Latest</span>
                            </div>
                            <button onclick="navTo('tests')" class="mt-4 text-primary text-sm font-bold hover:underline text-center w-full">Go to Test Series</button>
                        </div>
                    </div>
                </div>

                <!-- 4. TRAINING VIEW -->
                <div id="view-training" class="view-section hidden space-y-6">
                    <h2 class="text-2xl font-bold heading text-slate-900">Training Hub</h2>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Aptitude -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden group">
                            <div class="h-32 bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                                <i class="fa-solid fa-brain text-4xl text-white/90 group-hover:scale-110 transition duration-300"></i>
                            </div>
                            <div class="p-6">
                                <h3 class="font-bold text-lg mb-2">Aptitude & Logic</h3>
                                <ul class="text-sm text-slate-600 space-y-2 mb-4">
                                    <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500 text-xs"></i> Quantitative Ability</li>
                                    <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500 text-xs"></i> Logical Reasoning</li>
                                    <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500 text-xs"></i> Verbal Ability</li>
                                </ul>
                                <button onclick="startAITraining('Aptitude')" class="w-full py-2 border border-blue-500 text-blue-600 rounded-lg font-bold hover:bg-blue-50 transition">Start Learning</button>
                            </div>
                        </div>

                        <!-- Technical (Dynamic List) -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden group">
                            <div class="h-32 bg-gradient-to-r from-indigo-500 to-indigo-600 flex items-center justify-center">
                                <i class="fa-solid fa-code text-4xl text-white/90 group-hover:scale-110 transition duration-300"></i>
                            </div>
                            <div class="p-6">
                                <h3 class="font-bold text-lg mb-2">Technical Skills</h3>
                                <ul class="text-sm text-slate-600 space-y-2 mb-4" id="tech-skills-list">
                                    <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500 text-xs"></i> Domain Concepts</li>
                                    <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500 text-xs"></i> Core Tools</li>
                                    <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500 text-xs"></i> Best Practices</li>
                                </ul>
                                <button onclick="startAITraining('Technical')" class="w-full py-2 border border-indigo-500 text-primary rounded-lg font-bold hover:bg-indigo-50 transition">Start Learning</button>
                            </div>
                        </div>

                        <!-- HR -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden group">
                            <div class="h-32 bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                                <i class="fa-solid fa-users text-4xl text-white/90 group-hover:scale-110 transition duration-300"></i>
                            </div>
                            <div class="p-6">
                                <h3 class="font-bold text-lg mb-2">HR & Soft Skills</h3>
                                <ul class="text-sm text-slate-600 space-y-2 mb-4">
                                    <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500 text-xs"></i> Resume Writing</li>
                                    <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500 text-xs"></i> Body Language</li>
                                    <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500 text-xs"></i> Email Etiquette</li>
                                </ul>
                                <button onclick="startAITraining('HR')" class="w-full py-2 border border-purple-500 text-purple-600 rounded-lg font-bold hover:bg-purple-50 transition">Start Learning</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 8. ACTIVE TRAINING VIEW -->
                <div id="view-active-training" class="view-section hidden h-[calc(100vh-8rem)] flex flex-col bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                    <div class="bg-indigo-600 p-4 text-white flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-chalkboard-user text-2xl"></i>
                            <div>
                                <h3 class="font-bold text-lg" id="training-title">Technical Training</h3>
                                <p class="text-xs text-indigo-200" id="training-subtitle">Personalized</p>
                            </div>
                        </div>
                        <button onclick="navTo('training')" class="text-white hover:bg-indigo-700 p-2 rounded-lg"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-6" id="training-content">
                        <!-- AI Generated Content Goes Here -->
                        <div class="animate-pulse space-y-4">
                            <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                            <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                            <div class="h-4 bg-slate-200 rounded w-5/6"></div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-100 bg-slate-50 shrink-0">
                        <button onclick="generateTrainingContent()" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800 transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Generate New Topic
                        </button>
                    </div>
                </div>

                <!-- 5. TEST SERIES VIEW -->
                <div id="view-tests" class="view-section hidden space-y-6">
                    <h2 class="text-2xl font-bold heading text-slate-900">Test Series</h2>
                    
                    <div class="space-y-4">
                        <!-- Level 1 -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 flex flex-col md:flex-row items-center gap-6">
                            <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 text-xl font-bold">1</div>
                            <div class="flex-1 text-center md:text-left">
                                <h3 class="font-bold text-lg text-slate-900">Level 1: Aptitude Foundation</h3>
                                <p class="text-sm text-slate-500">20 Questions â€¢ 30 Minutes â€¢ Beginner</p>
                            </div>
                            <button onclick="startAITest(1, 'Aptitude')" class="px-6 py-2 bg-slate-900 text-white rounded-lg font-medium hover:bg-slate-700 transition">Take Test</button>
                        </div>

                        <!-- Level 2 -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 flex flex-col md:flex-row items-center gap-6">
                            <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 text-xl font-bold">2</div>
                            <div class="flex-1 text-center md:text-left">
                                <div class="flex items-center justify-center md:justify-start gap-2">
                                    <h3 class="font-bold text-lg text-slate-900">Level 2: Technical Core</h3>
                                </div>
                                <p class="text-sm text-slate-500">Coding & Domain MCQ â€¢ Intermediate</p>
                            </div>
                            <button onclick="startAITest(2, 'Technical')" class="px-6 py-2 bg-slate-900 text-white rounded-lg font-medium hover:bg-slate-700 transition">Take Test</button>
                        </div>

                        <!-- Level 3 -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 flex flex-col md:flex-row items-center gap-6">
                            <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 text-xl font-bold">3</div>
                            <div class="flex-1 text-center md:text-left">
                                <div class="flex items-center justify-center md:justify-start gap-2">
                                    <h3 class="font-bold text-lg text-slate-900">Level 3: Professional</h3>
                                </div>
                                <p class="text-sm text-slate-500">Scenario Based â€¢ Advanced</p>
                            </div>
                            <button onclick="startAITest(3, 'Professional')" class="px-6 py-2 bg-slate-900 text-white rounded-lg font-medium hover:bg-slate-700 transition">Take Test</button>
                        </div>
                    </div>
                </div>

                <!-- 9. ACTIVE TEST VIEW -->
                <div id="view-active-test" class="view-section hidden max-w-3xl mx-auto">
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div class="bg-slate-900 p-6 text-white text-center">
                            <h2 class="text-2xl font-bold heading" id="test-title">AI Generated Test</h2>
                            <p class="text-slate-400 text-sm" id="test-subtitle">Preparing questions...</p>
                        </div>
                        <div class="p-8">
                            <div id="ai-test-container">
                                <div class="text-center py-10" id="test-loader">
                                    <div class="loader mx-auto mb-4"></div>
                                    <p class="text-slate-600">AI is crafting questions for your profile...</p>
                                </div>
                                <div id="test-questions-area" class="hidden space-y-6">
                                    <!-- Questions injected here -->
                                </div>
                                <div id="test-results-area" class="hidden space-y-6">
                                    <div class="text-center">
                                        <div class="text-4xl font-bold text-primary mb-2" id="test-score-display">--/--</div>
                                        <p class="text-slate-500">Your Score</p>
                                    </div>
                                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm space-y-4" id="test-feedback">
                                        <!-- AI Correction -->
                                    </div>
                                    <button onclick="navTo('dashboard')" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold">Go to Dashboard</button>
                                </div>
                            </div>
                        </div>
                        <div class="px-8 py-4 bg-slate-50 border-t flex justify-between items-center hidden" id="test-footer">
                            <button onclick="submitAITest()" class="w-full bg-primary text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition">Submit Answers & Get AI Correction</button>
                        </div>
                    </div>
                </div>

                <!-- 6. AI INTERVIEW VIEW -->
                <div id="view-interview" class="view-section hidden h-[calc(100vh-8rem)] flex flex-col">
                    <div class="bg-white border border-slate-200 rounded-t-xl p-4 flex justify-between items-center shadow-sm shrink-0">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white">
                                <i class="fa-solid fa-robot"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800">CrackNest AI Interviewer</h3>
                                <p class="text-xs text-green-600 flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online</p>
                            </div>
                        </div>
                        <select id="interview-mode" class="bg-slate-50 border border-slate-200 text-sm rounded-lg px-3 py-1 outline-none">
                            <option value="HR">HR Round</option>
                            <option value="Technical">Technical Round</option>
                        </select>
                    </div>
                    
                    <div id="chat-history" class="flex-1 bg-slate-50 border-x border-slate-200 overflow-y-auto p-4 space-y-4">
                        <!-- Messages go here -->
                        <div class="flex gap-3 max-w-[80%]">
                            <div class="w-8 h-8 rounded-full bg-indigo-100 flex-shrink-0 flex items-center justify-center text-indigo-600 text-xs"><i class="fa-solid fa-robot"></i></div>
                            <div class="bg-white border border-slate-200 p-3 rounded-2xl rounded-tl-none text-sm text-slate-700 shadow-sm">
                                Hello! I'm your AI interviewer. Choose a mode above and type "Start" to begin our mock interview.
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-b-xl p-4 shrink-0">
                        <form id="chat-form" class="flex gap-2">
                            <input type="text" id="chat-input" class="flex-1 border border-slate-200 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary/20 outline-none" placeholder="Type your answer...">
                            <button type="submit" class="bg-primary hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- 7. RESUME BUILDER VIEW -->
                <div id="view-resume" class="view-section hidden">
                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- Editor -->
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                <h2 class="text-xl font-bold heading mb-4">Resume Details</h2>
                                <div class="space-y-4">
                                    <input type="text" id="res-name" class="w-full p-2 border rounded" placeholder="Full Name" oninput="updateResume()">
                                    <input type="text" id="res-email" class="w-full p-2 border rounded" placeholder="Email" oninput="updateResume()">
                                    <input type="text" id="res-phone" class="w-full p-2 border rounded" placeholder="Phone" oninput="updateResume()">
                                    <textarea id="res-summary" class="w-full p-2 border rounded" rows="3" placeholder="Professional Summary" oninput="updateResume()"></textarea>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                <h3 class="font-bold mb-3">Experience & Education</h3>
                                <textarea id="res-exp" class="w-full p-2 border rounded mb-3" rows="4" placeholder="Experience (Use bullets)" oninput="updateResume()"></textarea>
                                <textarea id="res-edu" class="w-full p-2 border rounded" rows="3" placeholder="Education Details" oninput="updateResume()"></textarea>
                            </div>

                             <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                <h3 class="font-bold mb-3">Skills</h3>
                                <input type="text" id="res-skills-input" class="w-full p-2 border rounded" placeholder="Skills (comma separated)" oninput="updateResume()">
                            </div>

                            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                <div class="flex items-start gap-3">
                                    <i class="fa-solid fa-wand-magic-sparkles text-primary mt-1"></i>
                                    <div>
                                        <h4 class="font-bold text-primary text-sm">AI Suggestion</h4>
                                        <p class="text-xs text-indigo-700 mt-1" id="ai-suggestion-text">Fill in your summary and click the wand to get an AI improvement!</p>
                                        <button onclick="improveSummary()" class="mt-2 text-xs bg-white text-primary px-3 py-1 rounded border border-indigo-200 font-bold hover:bg-indigo-50">Improve Summary</button>
                                    </div>
                                </div>
                            </div>

                            <button onclick="window.print()" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800">
                                <i class="fa-solid fa-download mr-2"></i> Download PDF
                            </button>
                        </div>

                        <!-- Preview -->
                        <div class="bg-white shadow-2xl p-8 min-h-[800px] text-sm text-slate-800" id="resume-preview">
                            <div class="border-b-2 border-slate-800 pb-4 mb-6">
                                <h1 class="text-3xl font-bold uppercase tracking-wide text-slate-900" id="prev-name">Your Name</h1>
                                <div class="flex gap-4 mt-2 text-slate-600 text-xs">
                                    <span id="prev-email">email@example.com</span> | <span id="prev-phone">+1234567890</span>
                                </div>
                            </div>

                            <div class="mb-6">
                                <h3 class="font-bold uppercase tracking-wider text-slate-900 border-b border-slate-200 mb-2 pb-1">Summary</h3>
                                <p class="text-slate-700 leading-relaxed" id="prev-summary">Professional summary goes here...</p>
                            </div>

                            <div class="mb-6">
                                <h3 class="font-bold uppercase tracking-wider text-slate-900 border-b border-slate-200 mb-2 pb-1">Experience</h3>
                                <div class="text-slate-700 whitespace-pre-line leading-relaxed" id="prev-exp">No experience added yet.</div>
                            </div>

                            <div class="mb-6">
                                <h3 class="font-bold uppercase tracking-wider text-slate-900 border-b border-slate-200 mb-2 pb-1">Education</h3>
                                <div class="text-slate-700 whitespace-pre-line leading-relaxed" id="prev-edu">No education added yet.</div>
                            </div>
                            
                            <div class="mb-6">
                                <h3 class="font-bold uppercase tracking-wider text-slate-900 border-b border-slate-200 mb-2 pb-1">Skills</h3>
                                <div class="flex flex-wrap gap-2" id="prev-skills">
                                    <!-- Pills -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script>
        // --- Mock Firebase using LocalStorage ---
        const db = {}; 
        const auth = {}; 

        const doc = (dbInstance, ...pathSegments) => {
            return pathSegments.join('_'); 
        };

        const getDoc = async (docPath) => {
            const stored = localStorage.getItem(docPath);
            return {
                exists: () => stored !== null,
                data: () => stored ? JSON.parse(stored) : undefined
            };
        };

        const setDoc = async (docPath, data) => {
            localStorage.setItem(docPath, JSON.stringify(data));
        };

        const signOut = async () => {
            window.location.href = "index.html";
        };

        const onAuthStateChanged = (authInstance, callback) => {
            setTimeout(() => {
                const mockUser = {
                    uid: 'offline_user_123',
                    email: 'student@cracknest.local',
                    // UPDATED: Initial generic name
                    displayName: 'Student'
                };
                callback(mockUser);
            }, 500); 
            return () => {}; 
        };

        const appId = 'cracknest-v1'; 

        // Global State
        let currentUser = null;
        let userProfile = null;
        let baselineScore = 0;
        let baselineQuestions = [];
        let activeTestQuestions = [];
        let activeTrainingModule = "";

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const loadingError = document.getElementById('loading-error');
        const appContainer = document.getElementById('app-container');
        const sidebar = document.getElementById('sidebar');
        const mobileHeader = document.getElementById('mobile-header');
        
        const views = {
            setup: document.getElementById('view-profile-setup'),
            baseline: document.getElementById('view-baseline-test'),
            dashboard: document.getElementById('view-dashboard'),
            training: document.getElementById('view-training'),
            activeTraining: document.getElementById('view-active-training'),
            tests: document.getElementById('view-tests'),
            activeTest: document.getElementById('view-active-test'),
            interview: document.getElementById('view-interview'),
            resume: document.getElementById('view-resume')
        };
        const navItems = document.querySelectorAll('.nav-item');

        // --- Navigation Control ---
        function toggleNavigation(show) {
            if (show) {
                sidebar.classList.remove('!hidden');
                mobileHeader.classList.remove('!hidden');
            } else {
                sidebar.classList.add('!hidden');
                mobileHeader.classList.add('!hidden');
            }
        }

        window.navTo = (target, isEdit = false) => {
            // Hide all
            Object.values(views).forEach(el => el.classList.add('hidden'));
            navItems.forEach(btn => btn.classList.remove('bg-slate-800', 'text-white'));
            
            // Show target
            if (views[target]) {
                views[target].classList.remove('hidden');
                const activeBtn = document.querySelector(`.nav-item[data-target="${target}"]`);
                if(activeBtn) activeBtn.classList.add('bg-slate-800', 'text-white');
            }

            // Special Case: Profile Edit Mode
            if (target === 'setup' && isEdit && userProfile) {
                document.getElementById('profile-title').textContent = "Edit Your Profile";
                document.getElementById('save-profile-btn').textContent = "Update Profile";
                // Pre-fill fields
                document.getElementById('p-name').value = userProfile.name || "";
                document.getElementById('p-degree').value = userProfile.degree || "";
                document.getElementById('p-year').value = userProfile.year || "";
                document.getElementById('p-exp').value = userProfile.exp || "Fresher";
                document.getElementById('p-field').value = userProfile.field || "IT";
                document.getElementById('p-role').value = userProfile.role || "";
                document.getElementById('p-certs').value = userProfile.certs || "";
                document.getElementById('p-langs').value = userProfile.langs || "";
                document.getElementById('p-skills').value = userProfile.skills || "";
            }
        };

        // --- Auth & Init Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('sidebar-avatar').textContent = user.email[0].toUpperCase();
                // UPDATED: Set sidebar name immediately if available in mock/user or wait for profile
                const sidebarNameEl = document.getElementById('sidebar-name');
                if (sidebarNameEl) sidebarNameEl.textContent = user.displayName || "Student";

                try {
                    const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
                    const baselineRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'baseline');
                    
                    const [profileSnap, baselineSnap] = await Promise.all([getDoc(profileRef), getDoc(baselineRef)]);

                    loadingScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');

                    if (!profileSnap.exists()) {
                        toggleNavigation(false);
                        navTo('setup');
                    } else if (!baselineSnap.exists()) {
                        userProfile = profileSnap.data();
                        // UPDATED: Ensure sidebar updates even in intermediate state
                        if(userProfile.name && sidebarNameEl) sidebarNameEl.textContent = userProfile.name;
                        
                        toggleNavigation(false); 
                        startBaselineAssessment();
                    } else {
                        userProfile = profileSnap.data();
                        // Initialize history/modules if missing
                        if (!userProfile.testHistory) userProfile.testHistory = [];
                        if (!userProfile.modulesCompleted) userProfile.modulesCompleted = 0;
                        
                        baselineScore = baselineSnap.data().score;
                        toggleNavigation(true);
                        loadDashboardData();
                        navTo('dashboard');
                        window.updateResume();
                    }
                } catch (e) {
                    console.error("Profile Load Error", e);
                    loadingError.textContent = `Error: ${e.message}. Please refresh.`;
                    loadingError.classList.remove('hidden');
                }
            } else {
                try {
                    window.location.replace("index.html");
                } catch (e) {
                    loadingScreen.classList.add('hidden');
                    document.body.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-screen bg-slate-50 text-slate-800">
                            <div class="text-center space-y-4">
                                <h1 class="text-2xl font-bold">Authentication Required</h1>
                                <a href="index.html" class="inline-block px-6 py-3 bg-indigo-600 text-white rounded-lg font-bold">Go to Login Page</a>
                            </div>
                        </div>
                    `;
                }
            }
        });

        // --- 1. Profile Setup/Update Logic ---
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('p-name').value,
                degree: document.getElementById('p-degree').value,
                year: document.getElementById('p-year').value,
                exp: document.getElementById('p-exp').value,
                field: document.getElementById('p-field').value,
                role: document.getElementById('p-role').value,
                certs: document.getElementById('p-certs').value,
                langs: document.getElementById('p-langs').value,
                skills: document.getElementById('p-skills').value,
                joinedAt: userProfile?.joinedAt || new Date().toISOString(),
                // Preserve History
                testHistory: userProfile?.testHistory || [],
                modulesCompleted: userProfile?.modulesCompleted || 0
            };

            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;
            btn.textContent = "Saving...";
            
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data'), data);
                userProfile = data;
                
                // Update sidebar immediately
                const sidebarNameEl = document.getElementById('sidebar-name');
                if (sidebarNameEl) sidebarNameEl.textContent = data.name;

                if (sidebar.classList.contains('!hidden') || sidebar.style.display !== 'none' && !sidebar.classList.contains('hidden')) {
                     alert("Profile Updated Successfully!");
                     navTo('dashboard');
                } else {
                     startBaselineAssessment(); 
                }
            } catch (err) {
                alert("Error saving profile: " + err.message);
            } finally {
                btn.textContent = originalText;
            }
        });

        // --- 2. Baseline Test Logic ---
        let currentQIndex = 0;
        let score = 0;

        async function startBaselineAssessment() {
            navTo('baseline');
            document.getElementById('quiz-container').innerHTML = `
                <div class="text-center py-12">
                    <div class="loader mx-auto mb-4"></div>
                    <h3 class="text-xl font-bold text-slate-700">Generating Your Assessment</h3>
                    <p class="text-slate-500">AI is crafting questions based on your profile...</p>
                </div>
            `;
            document.getElementById('quiz-footer').classList.add('hidden');

            const prompt = `Generate 5 multiple choice questions for a baseline skill assessment for a ${userProfile.role} in ${userProfile.field}. 
            Format strictly as a JSON array of objects with keys: "q", "options" (4 strings), "a" (index 0-3). Return ONLY JSON.`;

            try {
                const text = await callGemini(prompt);
                const cleaned = text.replace(/```json/g, '').replace(/```/g, '').trim();
                baselineQuestions = JSON.parse(cleaned);
                
                document.getElementById('quiz-container').innerHTML = `
                    <div class="mb-6">
                        <span class="text-xs font-bold text-primary uppercase tracking-wide">Question <span id="q-current">1</span> of <span id="q-total">10</span></span>
                        <h3 class="text-lg font-medium text-slate-900 mt-2" id="q-text"></h3>
                    </div>
                    <div class="space-y-3" id="q-options"></div>
                `;
                document.getElementById('quiz-footer').classList.remove('hidden');
                
                currentQIndex = 0;
                score = 0;
                loadQuestion();

            } catch (e) {
                baselineQuestions = [{ q: "What is 2+2?", options: ["3", "4", "5", "6"], a: 1 }];
                currentQIndex = 0; score = 0; loadQuestion();
            }
        }

        function loadQuestion() {
            if (currentQIndex >= baselineQuestions.length) {
                finishQuiz();
                return;
            }
            const q = baselineQuestions[currentQIndex];
            document.getElementById('q-current').textContent = currentQIndex + 1;
            document.getElementById('q-total').textContent = baselineQuestions.length;
            document.getElementById('q-text').textContent = q.q;
            document.getElementById('q-options').innerHTML = q.options.map((opt, i) => `
                <div onclick="selectOption(${i})" class="opt-btn p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 hover:border-indigo-300 transition" id="opt-${i}">${opt}</div>
            `).join('');
            
            const pct = ((currentQIndex) / baselineQuestions.length) * 100;
            document.getElementById('quiz-progress').style.width = `${pct}%`;
        }

        window.selectOption = (idx) => {
            document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('bg-indigo-600', 'text-white'));
            const sel = document.getElementById(`opt-${idx}`);
            sel.classList.add('bg-indigo-600', 'text-white');
            sel.dataset.selected = "true";
        };

        document.getElementById('next-q-btn').addEventListener('click', () => {
            const selected = document.querySelector('.opt-btn[data-selected="true"]');
            if (!selected) return alert("Please select an option.");
            
            const ansIdx = parseInt(selected.id.split('-')[1]);
            if (ansIdx === baselineQuestions[currentQIndex].a) score++;
            currentQIndex++;
            loadQuestion();
        });

        function finishQuiz() {
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-footer').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');
            const finalPct = Math.round((score / baselineQuestions.length) * 100);
            baselineScore = finalPct;
            document.getElementById('res-score').textContent = `${finalPct}%`;
            document.getElementById('res-level').textContent = finalPct > 70 ? "Advanced" : "Beginner";
            setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'baseline'), { score: finalPct, date: new Date().toISOString() });
        }

        window.finishBaseline = () => {
            toggleNavigation(true); 
            loadDashboardData();
            navTo('dashboard');
        }

        // --- 3. DYNAMIC DASHBOARD LOGIC (Updated) ---
        function loadDashboardData() {
            if (!userProfile) return;
            const nameEl = document.getElementById('dash-name');
            const roleEl = document.getElementById('dash-role');
            const pathEl = document.getElementById('dash-path');
            const modulesEl = document.getElementById('dash-modules');
            const readinessEl = document.getElementById('dash-readiness');
            
            // UPDATED: Sidebar name and role update
            const sidebarNameEl = document.getElementById('sidebar-name');
            const sidebarRoleEl = document.getElementById('sidebar-role');
            
            if (sidebarNameEl) sidebarNameEl.textContent = userProfile.name || 'Student';
            if (sidebarRoleEl) sidebarRoleEl.textContent = userProfile.role || 'Student';

            if (nameEl) nameEl.textContent = userProfile.name ? userProfile.name.split(' ')[0] : 'Student';
            if (roleEl) roleEl.textContent = userProfile.role || 'Not Set';
            
            // Dynamic Path Correction
            if (pathEl) pathEl.textContent = userProfile.field ? `${userProfile.field} Path` : 'Career Path';

            const completedCount = (userProfile.modulesCompleted || 0);
            if (modulesEl) modulesEl.textContent = completedCount;

            // Readiness Score Calculation
            let totalScore = baselineScore;
            let count = 1;
            if (userProfile.testHistory) {
                userProfile.testHistory.forEach(t => {
                    totalScore += t.score;
                    count++;
                });
            }
            const readiness = Math.round(totalScore / count);
            if (readinessEl) readinessEl.textContent = `${readiness}%`;
            document.getElementById('dash-readiness-bar').style.width = `${readiness}%`;

            // Performance Graph Logic
            const graphContainer = document.getElementById('score-bars');
            const emptyMsg = document.getElementById('empty-graph-msg');
            
            if (userProfile.testHistory && userProfile.testHistory.length > 0) {
                emptyMsg.classList.add('hidden');
                graphContainer.classList.remove('hidden');
                const recentTests = userProfile.testHistory.slice(-5);
                graphContainer.innerHTML = recentTests.map(t => `
                    <div class="bar" style="height: ${t.score}%;" data-score="${t.score}" title="Score: ${t.score}%"></div>
                `).join('');
            } else {
                emptyMsg.classList.remove('hidden');
                graphContainer.classList.add('hidden');
            }

            // --- Dynamic Technical Skills List Update ---
            const techList = document.getElementById('tech-skills-list');
            if (techList) {
                const field = userProfile.field || 'IT';
                let skills = ["Core Concepts", "Advanced Techniques", "Industry Standards"];

                switch(field) {
                    case 'IT': skills = ["DSA & Algorithms", "System Design", "Database Mgmt"]; break;
                    case 'Marketing': skills = ["SEO & SEM", "Content Strategy", "Market Analytics"]; break;
                    case 'Finance': skills = ["Financial Modeling", "Risk Management", "Investment Analysis"]; break;
                    case 'HR': skills = ["Talent Acquisition", "Labor Laws", "Employee Relations"]; break;
                    case 'Engineering': skills = ["Core Principles", "CAD/Simulations", "Project Management"]; break;
                    case 'Accounting': skills = ["Taxation", "Auditing Standards", "Financial Reporting"]; break;
                    case 'Data': skills = ["SQL & Python", "Machine Learning", "Data Visualization"]; break;
                }

                techList.innerHTML = skills.map(s => 
                    `<li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500 text-xs"></i> ${s}</li>`
                ).join('');
            }
        }

        // --- 4. Resume Logic ---
        window.updateResume = () => {
            if(!userProfile) return;
            document.getElementById('prev-name').textContent = document.getElementById('res-name').value || userProfile.name || "Your Name";
            document.getElementById('prev-email').textContent = document.getElementById('res-email').value || "email@example.com";
            document.getElementById('prev-phone').textContent = document.getElementById('res-phone').value || "Phone";
            if(!document.getElementById('res-skills-input').value && userProfile.skills) {
                document.getElementById('res-skills-input').value = userProfile.skills;
            }
            const skills = document.getElementById('res-skills-input').value.split(',');
            document.getElementById('prev-skills').innerHTML = skills.map(s => s.trim() ? `<span class="bg-slate-200 px-2 py-1 rounded text-xs">${s.trim()}</span>` : "").join('');
            const summary = document.getElementById('res-summary').value;
            if(summary) document.getElementById('prev-summary').textContent = summary;
        };

        // --- 5. AI Features (Gemini) ---
        // API Key is now handled securely on the server side (Vercel)

        async function callGemini(prompt) {
        try {
            const response = await fetch('/api/gemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });
    
            // 1. Handle Rate Limit Specifically
            if (response.status === 429) {
                console.warn("Rate Limit Hit");
                return "I'm thinking too hard! Please wait 30 seconds and try again.";
            }
    
            // 2. Handle Other Errors
            if (!response.ok) {
                throw new Error(`Server Error: ${response.status}`);
            }
    
            const data = await response.json();
            
            if (data.candidates && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            } else {
                return "I couldn't generate a response. Please try again.";
            }
        } catch (e) {
            console.error("API Error:", e);
            return "Connection issue. Please check your internet or try again later.";
        }
    }

        window.improveSummary = async () => {
            const current = document.getElementById('res-summary').value;
            if(!current) return alert("Write a draft summary first!");
            const originalText = document.getElementById('ai-suggestion-text').innerText;
            document.getElementById('ai-suggestion-text').innerText = "AI is thinking...";
            const prompt = `Rewrite this resume summary for a ${userProfile?.role} with skills ${userProfile?.skills}: "${current}"`;
            const improved = await callGemini(prompt);
            document.getElementById('res-summary').value = improved;
            document.getElementById('ai-suggestion-text').innerText = "Summary updated!";
            updateResume();
        }

        const chatForm = document.getElementById('chat-form');
        const chatHistory = document.getElementById('chat-history');
        
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;
            appendMessage('user', msg);
            input.value = '';
            const mode = document.getElementById('interview-mode').value;
            const context = `You are a strict ${mode} interviewer for ${userProfile?.role}. Candidate says: "${msg}". Respond in <50 words.`;
            const loadingId = appendMessage('ai', '...');
            const reply = await callGemini(context);
            document.getElementById(loadingId).innerText = reply;
        });

        function appendMessage(role, text) {
            const id = 'msg-' + Date.now();
            const isAI = role === 'ai';
            const html = `
                <div class="flex gap-3 max-w-[80%] ${isAI ? '' : 'ml-auto flex-row-reverse'} message-enter">
                    <div class="w-8 h-8 rounded-full ${isAI ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-200 text-slate-600'} flex-shrink-0 flex items-center justify-center text-xs">
                        <i class="fa-solid ${isAI ? 'fa-robot' : 'fa-user'}"></i>
                    </div>
                    <div class="${isAI ? 'bg-white border border-slate-200 rounded-tl-none' : 'bg-primary text-white rounded-tr-none'} p-3 rounded-2xl text-sm shadow-sm" id="${id}">
                        ${text}
                    </div>
                </div>
            `;
            chatHistory.insertAdjacentHTML('beforeend', html);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return id;
        }

        // --- 6. AI Test Series Logic ---
        window.startAITest = async (level, type) => {
            navTo('activeTest');
            document.getElementById('test-title').textContent = `${type} Assessment (Level ${level})`;
            document.getElementById('test-subtitle').textContent = `Customized for ${userProfile?.role || 'General'}...`;
            document.getElementById('ai-test-container').querySelector('#test-loader').classList.remove('hidden');
            document.getElementById('test-questions-area').classList.add('hidden');
            document.getElementById('test-results-area').classList.add('hidden');
            document.getElementById('test-footer').classList.add('hidden');

            const prompt = `Generate 5 multiple choice questions for a ${type} test for a ${userProfile?.role}. Level ${level}.
            Format as JSON array: [{"q": "Question?", "options": ["A", "B", "C", "D"], "a": 0}] (a is index). Return ONLY JSON.`;

            try {
                const response = await callGemini(prompt);
                const cleaned = response.replace(/```json/g, '').replace(/```/g, '').trim();
                activeTestQuestions = JSON.parse(cleaned);
            } catch (e) {
                activeTestQuestions = [
                    { q: `Concept in ${userProfile?.field}?`, options: ["A", "B", "C", "D"], a: 0 },
                    { q: "Another Question?", options: ["1", "2", "3", "4"], a: 1 }
                ];
            }

            const area = document.getElementById('test-questions-area');
            area.innerHTML = activeTestQuestions.map((q, i) => `
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <p class="font-bold mb-3">${i+1}. ${q.q}</p>
                    <div class="space-y-2">
                        ${q.options.map((opt, oid) => `
                            <label class="flex items-center gap-3 p-3 bg-white border border-slate-200 rounded-lg cursor-pointer hover:bg-indigo-50">
                                <input type="radio" name="q${i}" value="${oid}" class="accent-primary">
                                <span class="text-sm">${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            document.getElementById('ai-test-container').querySelector('#test-loader').classList.add('hidden');
            area.classList.remove('hidden');
            document.getElementById('test-footer').classList.remove('hidden');
        };

        window.submitAITest = async () => {
            let score = 0;
            activeTestQuestions.forEach((q, i) => {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                if(selected && parseInt(selected.value) === q.a) score++;
            });

            const percentage = Math.round((score / activeTestQuestions.length) * 100);

            // Update Profile History
            if (!userProfile.testHistory) userProfile.testHistory = [];
            userProfile.testHistory.push({
                date: new Date().toISOString(),
                score: percentage,
                total: activeTestQuestions.length,
                type: document.getElementById('test-title').textContent
            });
            userProfile.modulesCompleted = (userProfile.modulesCompleted || 0) + 1;

            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data'), userProfile);

            document.getElementById('test-questions-area').classList.add('hidden');
            document.getElementById('test-footer').classList.add('hidden');
            
            const resultsArea = document.getElementById('test-results-area');
            resultsArea.classList.remove('hidden');
            document.getElementById('test-score-display').textContent = `${percentage}%`;
            
            const feedbackPrompt = `I got ${score}/${activeTestQuestions.length} on a ${userProfile.role} test. Give short feedback.`;
            const feedback = await callGemini(feedbackPrompt);
            document.getElementById('test-feedback').innerHTML = `<p>${feedback}</p>`;
        };

        // --- 7. AI Training Hub Logic ---
        window.startAITraining = (module) => {
            navTo('activeTraining');
            activeTrainingModule = module;
            document.getElementById('training-title').textContent = `${module} Training`;
            document.getElementById('training-subtitle').textContent = `Customized for ${userProfile?.role}`;
            generateTrainingContent();
        };

        window.generateTrainingContent = async () => {
            const container = document.getElementById('training-content');
            container.innerHTML = `<div class='text-center py-10'><div class='loader mx-auto mb-4'></div><p class='text-slate-500'>AI Trainer is preparing lesson...</p></div>`;
            const prompt = `Teach a ${userProfile?.role} about ${activeTrainingModule}. Short lesson + 1 quiz question. HTML format.`;
            const content = await callGemini(prompt);
            container.innerHTML = content;
            
            // Increment module
            userProfile.modulesCompleted = (userProfile.modulesCompleted || 0) + 1;
            setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data'), userProfile);
        };

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                try { window.location.href = "index.html"; } catch(e) { window.location.reload(); }
            });
        });
    </script>
</body>
</html>
