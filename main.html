<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | CrackNest</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // Indigo 600
                        secondary: '#F59E0B', // Amber 500
                        dark: '#0F172A', // Slate 900
                        light: '#F8FAFC', // Slate 50
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        .sidebar-link.active {
            background-color: #EEF2FF; /* Indigo 50 */
            color: #4F46E5; /* Primary */
            border-right: 3px solid #4F46E5;
        }
        /* Custom Scrollbar for Chat */
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        
        /* Loading Dots */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="font-sans text-slate-600 bg-slate-50 antialiased h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r border-slate-200 flex-col hidden md:flex z-20">
        <div class="h-20 flex items-center px-6 border-b border-slate-100">
            <span class="font-heading font-bold text-2xl text-slate-800">Crack<span class="text-primary">Nest</span></span>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            <button onclick="navTo('dashboard')" id="nav-dashboard" class="sidebar-link w-full text-left px-4 py-3 rounded-lg font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-3">
                <i class="fa-solid fa-chart-pie w-6"></i> Dashboard
            </button>
            <button onclick="navTo('profile')" id="nav-profile" class="sidebar-link w-full text-left px-4 py-3 rounded-lg font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-3">
                <i class="fa-solid fa-user-gear w-6"></i> Profile & Target
            </button>
            <button onclick="navTo('roadmap')" id="nav-roadmap" class="sidebar-link w-full text-left px-4 py-3 rounded-lg font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-3">
                <i class="fa-solid fa-map w-6"></i> Personalized Plan
            </button>
            <button onclick="navTo('tests')" id="nav-tests" class="sidebar-link w-full text-left px-4 py-3 rounded-lg font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-3">
                <i class="fa-solid fa-list-check w-6"></i> Test Series
            </button>
            <button onclick="navTo('interview')" id="nav-interview" class="sidebar-link w-full text-left px-4 py-3 rounded-lg font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-3">
                <i class="fa-solid fa-robot w-6 text-purple-500"></i> AI Mock Interview
            </button>
            <button onclick="navTo('resume')" id="nav-resume" class="sidebar-link w-full text-left px-4 py-3 rounded-lg font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-3">
                <i class="fa-solid fa-file-pen w-6"></i> Resume Builder
            </button>
        </nav>

        <div class="p-4 border-t border-slate-100">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold" id="sidebar-avatar">U</div>
                <div>
                    <p class="text-sm font-bold text-slate-800" id="sidebar-name">User</p>
                    <p class="text-xs text-slate-400">Student</p>
                </div>
            </div>
            <button id="logout-btn" class="w-full border border-slate-200 text-slate-600 hover:text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg text-sm font-medium transition">
                Sign Out
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 md:hidden flex-shrink-0">
            <span class="font-heading font-bold text-xl text-slate-800">Crack<span class="text-primary">Nest</span></span>
            <button id="mobile-menu-toggle" class="text-slate-600"><i class="fa-solid fa-bars text-xl"></i></button>
        </header>

        <div id="api-key-banner" class="bg-indigo-900 text-white px-6 py-2 text-xs flex justify-between items-center z-50">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-key"></i>
                <span>Gemini API Key required for AI features.</span>
            </div>
            <div class="flex gap-2">
                <input type="password" id="gemini-key-input" placeholder="Paste API Key here" class="text-slate-800 px-2 py-1 rounded text-xs w-48">
                <button onclick="saveApiKey()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition">Save</button>
            </div>
        </div>

        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 relative">
            
            <section id="section-profile" class="max-w-3xl mx-auto hidden animate-fade-in">
                <div class="mb-8">
                    <h1 class="font-heading text-3xl font-bold text-slate-900">Let's Personalize Your Prep</h1>
                    <p class="text-slate-500">Tell us about yourself so we can build your roadmap.</p>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-100">
                    <form id="profile-form" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Full Name</label>
                                <input type="text" id="p-name" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Degree / Stream</label>
                                <input type="text" id="p-degree" placeholder="e.g. B.Tech CSE" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Target Career Role</label>
                            <select id="p-role" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition bg-white">
                                <option value="Software Developer">Software Developer (SDE)</option>
                                <option value="Data Analyst">Data Analyst</option>
                                <option value="Product Manager">Product Manager</option>
                                <option value="Marketing">Digital Marketing</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Experience Level</label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 border px-4 py-3 rounded-lg cursor-pointer hover:bg-slate-50 w-full">
                                    <input type="radio" name="exp" value="fresher" checked class="text-primary focus:ring-primary">
                                    <span class="font-medium">Fresher / Student</span>
                                </label>
                                <label class="flex items-center gap-2 border px-4 py-3 rounded-lg cursor-pointer hover:bg-slate-50 w-full">
                                    <input type="radio" name="exp" value="experienced" class="text-primary focus:ring-primary">
                                    <span class="font-medium">Experienced Pro</span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-500/20 transition transform hover:-translate-y-1">
                            Save & Start Baseline Test
                        </button>
                    </form>
                </div>
            </section>

            <section id="section-skilltest" class="max-w-3xl mx-auto hidden">
                <div class="text-center mb-8">
                    <span class="bg-indigo-50 text-primary px-3 py-1 rounded-full text-sm font-bold">Step 2 of 2</span>
                    <h2 class="font-heading text-3xl font-bold text-slate-900 mt-4">Baseline Assessment</h2>
                    <p class="text-slate-500">Analyzing your current level for <span id="test-role-display" class="font-bold text-slate-800">Software Developer</span></p>
                </div>

                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
                    <div class="bg-slate-50 px-8 py-4 border-b border-slate-100 flex justify-between items-center">
                        <span class="font-bold text-slate-700">Question <span id="q-number">1</span>/3</span>
                        <div class="flex gap-1">
                            <div class="w-2 h-2 rounded-full bg-primary"></div>
                            <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                            <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                        </div>
                    </div>
                    
                    <div class="p-8">
                        <p id="q-text" class="text-lg font-medium text-slate-800 mb-6">What is the time complexity of a binary search algorithm?</p>
                        
                        <div id="q-options" class="space-y-3">
                            <button class="w-full text-left p-4 rounded-lg border border-slate-200 hover:border-primary hover:bg-indigo-50 transition">O(n)</button>
                            <button class="w-full text-left p-4 rounded-lg border border-slate-200 hover:border-primary hover:bg-indigo-50 transition">O(log n)</button>
                        </div>
                    </div>

                    <div class="p-8 border-t border-slate-100 flex justify-end">
                        <button onclick="handleNextQuestion()" class="bg-primary text-white px-6 py-2 rounded-lg font-semibold">Next <i class="fa-solid fa-arrow-right ml-2"></i></button>
                    </div>
                </div>
            </section>

            <section id="section-dashboard" class="hidden space-y-8">
                <div class="bg-gradient-to-r from-primary to-purple-600 rounded-2xl p-8 text-white shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <h1 class="font-heading text-3xl font-bold mb-2">Welcome back, <span id="dash-name">User</span>!</h1>
                        <p class="text-indigo-100 mb-6 max-w-xl">Your interview readiness score is <span class="font-bold text-white bg-white/20 px-2 py-0.5 rounded">65%</span>. Keep going to reach the 90% confidence zone.</p>
                        <button onclick="navTo('roadmap')" class="bg-white text-primary px-6 py-2.5 rounded-lg font-bold hover:bg-indigo-50 transition shadow-lg">Continue Roadmap</button>
                    </div>
                    <i class="fa-solid fa-trophy absolute -bottom-4 -right-4 text-9xl text-white/10 rotate-12"></i>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-4 mb-2">
                            <div class="w-10 h-10 rounded-lg bg-green-100 text-green-600 flex items-center justify-center"><i class="fa-solid fa-code"></i></div>
                            <h3 class="font-bold text-slate-700">Technical</h3>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2 mb-2"><div class="bg-green-500 h-2 rounded-full" style="width: 70%"></div></div>
                        <p class="text-xs text-slate-500">DSA & Core Concepts</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-4 mb-2">
                            <div class="w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-brain"></i></div>
                            <h3 class="font-bold text-slate-700">Aptitude</h3>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2 mb-2"><div class="bg-blue-500 h-2 rounded-full" style="width: 45%"></div></div>
                        <p class="text-xs text-slate-500">Logical & Quant</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-4 mb-2">
                            <div class="w-10 h-10 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fa-solid fa-comments"></i></div>
                            <h3 class="font-bold text-slate-700">Communication</h3>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2 mb-2"><div class="bg-purple-500 h-2 rounded-full" style="width: 30%"></div></div>
                        <p class="text-xs text-slate-500">HR & Soft Skills</p>
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-xl text-slate-800 mb-4">Recommended for Today</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-xl border border-slate-100 flex items-center gap-4 hover:shadow-md transition cursor-pointer">
                            <div class="w-16 h-16 rounded-lg bg-slate-100 flex items-center justify-center text-2xl text-slate-400"><i class="fa-brands fa-youtube"></i></div>
                            <div>
                                <h4 class="font-bold text-slate-800">Array Manipulation Basics</h4>
                                <p class="text-sm text-slate-500">Technical • 15 mins</p>
                            </div>
                            <button class="ml-auto text-primary font-bold text-sm">Start</button>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-slate-100 flex items-center gap-4 hover:shadow-md transition cursor-pointer">
                            <div class="w-16 h-16 rounded-lg bg-slate-100 flex items-center justify-center text-2xl text-slate-400"><i class="fa-solid fa-pen-nib"></i></div>
                            <div>
                                <h4 class="font-bold text-slate-800">"Tell me about yourself"</h4>
                                <p class="text-sm text-slate-500">HR Prep • 10 mins</p>
                            </div>
                            <button class="ml-auto text-primary font-bold text-sm">Practice</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="section-interview" class="hidden h-full flex flex-col">
                <div class="mb-4 flex justify-between items-center">
                    <div>
                        <h2 class="font-heading text-2xl font-bold text-slate-900">AI Mock Interview</h2>
                        <p class="text-sm text-slate-500">Real-time feedback on your answers.</p>
                    </div>
                    <div class="flex gap-2">
                        <select id="interview-type" class="border border-slate-200 rounded-lg px-3 py-1 text-sm">
                            <option value="HR">HR Round</option>
                            <option value="Technical">Technical Round</option>
                        </select>
                        <button onclick="startInterview()" class="bg-primary text-white px-4 py-1.5 rounded-lg text-sm font-bold">New Session</button>
                    </div>
                </div>

                <div class="flex-1 bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col overflow-hidden">
                    <div id="chat-history" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50/50 chat-scroll">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-full bg-primary flex-shrink-0 flex items-center justify-center text-white text-xs"><i class="fa-solid fa-robot"></i></div>
                            <div class="bg-white border border-slate-200 p-3 rounded-2xl rounded-tl-none text-slate-700 text-sm shadow-sm max-w-[80%]">
                                Hello! I am your AI Interviewer. Please select a mode and click "New Session" to begin.
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-white border-t border-slate-100">
                        <div class="relative">
                            <textarea id="chat-input" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-4 pr-12 py-3 focus:outline-none focus:ring-2 focus:ring-primary/20 resize-none" placeholder="Type your answer here..."></textarea>
                            <button onclick="sendChatMessage()" class="absolute right-3 top-3 w-8 h-8 bg-primary text-white rounded-lg flex items-center justify-center hover:bg-indigo-700 transition">
                                <i class="fa-solid fa-paper-plane text-xs"></i>
                            </button>
                        </div>
                        <p class="text-xs text-center text-slate-400 mt-2"><i class="fa-solid fa-bolt text-secondary"></i> Powered by Gemini AI</p>
                    </div>
                </div>
            </section>

            <section id="section-resume" class="hidden max-w-4xl mx-auto">
                <div class="mb-6">
                    <h2 class="font-heading text-2xl font-bold text-slate-900">Smart Resume Builder</h2>
                    <p class="text-slate-500">Create an ATS-friendly resume with AI assistance.</p>
                </div>

                <div class="grid lg:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-4 border-b pb-2">Professional Summary</h3>
                            <div class="relative">
                                <textarea id="resume-summary" class="w-full h-32 p-3 border border-slate-200 rounded-lg text-sm" placeholder="e.g. Energetic Computer Science graduate with strong skills in Java and Python..."></textarea>
                                <button onclick="aiOptimizeResume()" class="absolute right-2 bottom-2 bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-md font-bold hover:bg-purple-200 transition flex items-center gap-1">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i> AI Enhance
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-4 border-b pb-2">Skills</h3>
                            <input type="text" id="resume-skills" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="Java, Python, SQL, React...">
                        </div>

                        <button onclick="generatePreview()" class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold">Update Preview</button>
                    </div>

                    <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 min-h-[500px]" id="resume-preview">
                        <div class="text-center border-b pb-4 mb-4">
                            <h1 class="text-2xl font-bold text-slate-900 uppercase" id="prev-name">Your Name</h1>
                            <p class="text-slate-500 text-sm" id="prev-role">Software Developer</p>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-xs font-bold uppercase text-slate-400 mb-2 tracking-wider">Summary</h4>
                            <p class="text-sm text-slate-700 leading-relaxed" id="prev-summary">Your summary will appear here.</p>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-xs font-bold uppercase text-slate-400 mb-2 tracking-wider">Skills</h4>
                            <div class="flex flex-wrap gap-2" id="prev-skills">
                                </div>
                        </div>
                    </div>
                </div>
            </section>

             <section id="section-tests" class="hidden">
                <div class="mb-6">
                    <h2 class="font-heading text-2xl font-bold text-slate-900">Evaluation Test Series</h2>
                    <p class="text-slate-500">Clear levels to earn your certification.</p>
                </div>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl border-l-4 border-l-green-500 shadow-sm relative">
                        <span class="absolute top-4 right-4 bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded">Unlocked</span>
                        <h3 class="font-bold text-lg text-slate-800 mb-2">Level 1: Aptitude</h3>
                        <p class="text-sm text-slate-500 mb-4">Quant, Logical, and Verbal reasoning basics.</p>
                        <div class="flex items-center justify-between mt-4">
                            <span class="text-xs font-bold text-slate-400">30 Mins</span>
                            <button class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-semibold">Start Test</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl border-l-4 border-l-slate-200 shadow-sm opacity-75 relative">
                         <span class="absolute top-4 right-4 bg-slate-100 text-slate-500 text-xs font-bold px-2 py-1 rounded"><i class="fa-solid fa-lock"></i> Locked</span>
                        <h3 class="font-bold text-lg text-slate-800 mb-2">Level 2: Technical</h3>
                        <p class="text-sm text-slate-500 mb-4">Deep dive into Coding and Core subjects.</p>
                        <div class="w-full bg-slate-100 h-2 rounded-full mt-4"><div class="w-0 bg-primary h-2 rounded-full"></div></div>
                        <p class="text-xs text-slate-400 mt-2">Complete Level 1 to unlock</p>
                    </div>

                    <div class="bg-white p-6 rounded-xl border-l-4 border-l-slate-200 shadow-sm opacity-75 relative">
                        <span class="absolute top-4 right-4 bg-slate-100 text-slate-500 text-xs font-bold px-2 py-1 rounded"><i class="fa-solid fa-lock"></i> Locked</span>
                        <h3 class="font-bold text-lg text-slate-800 mb-2">Level 3: HR & Final</h3>
                        <p class="text-sm text-slate-500 mb-4">Scenario based questions and culture fit.</p>
                        <div class="w-full bg-slate-100 h-2 rounded-full mt-4"><div class="w-0 bg-primary h-2 rounded-full"></div></div>
                    </div>
                </div>
             </section>

             <section id="section-roadmap" class="hidden">
                 <div class="text-center py-20">
                    <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-primary text-3xl">
                        <i class="fa-solid fa-map-location-dot"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800">Your roadmap is being generated...</h2>
                    <p class="text-slate-500">Based on your Skill Test results.</p>
                 </div>
             </section>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAGK_7tNXEyBCUjV9wqBDlbXmbpNxaH2mU",
            authDomain: "crak-a74d0.firebaseapp.com",
            projectId: "crak-a74d0",
            storageBucket: "crak-a74d0.firebasestorage.app",
            messagingSenderId: "106356918520",
            appId: "1:106356918520:web:e9affa0adef64574c1530d",
            measurementId: "G-YFG4XZWP68"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Auth Check
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('sidebar-name').innerText = user.displayName || user.email.split('@')[0];
                document.getElementById('sidebar-avatar').innerText = (user.email[0]).toUpperCase();
            } else {
                // Redirect if not logged in
                window.location.href = "index.html"; 
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "index.html");
        });
    </script>

    <script>
        // State Management
        let currentState = {
            view: 'profile', // Default start
            userProfile: {},
            apiKey: '',
            chatHistory: []
        };

        // Navigation
        function navTo(sectionId) {
            // Hide all sections
            document.querySelectorAll('section').forEach(sec => sec.classList.add('hidden'));
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));

            // Show target
            document.getElementById('section-' + sectionId).classList.remove('hidden');
            document.getElementById('section-' + sectionId).classList.add('animate-fade-in');
            
            // Highlight sidebar
            const navLink = document.getElementById('nav-' + sectionId);
            if(navLink) navLink.classList.add('active');

            currentState.view = sectionId;
        }

        // --- Feature 3: Profile Setup ---
        document.getElementById('profile-form').addEventListener('submit', (e) => {
            e.preventDefault();
            currentState.userProfile = {
                name: document.getElementById('p-name').value,
                role: document.getElementById('p-role').value,
                degree: document.getElementById('p-degree').value
            };
            
            // Update UI with names
            document.getElementById('dash-name').innerText = currentState.userProfile.name;
            document.getElementById('test-role-display').innerText = currentState.userProfile.role;
            document.getElementById('prev-name').innerText = currentState.userProfile.name;
            document.getElementById('prev-role').innerText = currentState.userProfile.role;

            // Move to Skill Test
            navTo('skilltest');
        });

        // --- Feature 4: Baseline Test (Mock) ---
        let currentQ = 0;
        const questions = [
            { t: "What is the time complexity of Binary Search?", opts: ["O(n)", "O(log n)", "O(n^2)"], a: 1 },
            { t: "Which structure follows LIFO?", opts: ["Queue", "Stack", "Array"], a: 1 },
            { t: "HTTP status 404 means?", opts: ["Server Error", "Not Found", "Success"], a: 1 }
        ];

        function loadQuestion() {
            if(currentQ >= questions.length) {
                // Test done, go to dashboard
                navTo('dashboard');
                return;
            }
            const q = questions[currentQ];
            document.getElementById('q-text').innerText = q.t;
            document.getElementById('q-number').innerText = currentQ + 1;
            
            const optsContainer = document.getElementById('q-options');
            optsContainer.innerHTML = '';
            q.opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-lg border border-slate-200 hover:border-primary hover:bg-indigo-50 transition";
                btn.innerText = opt;
                btn.onclick = () => {
                    // Visual selection
                    Array.from(optsContainer.children).forEach(c => c.classList.remove('bg-indigo-100', 'border-primary'));
                    btn.classList.add('bg-indigo-100', 'border-primary');
                };
                optsContainer.appendChild(btn);
            });
        }
        
        function handleNextQuestion() {
            currentQ++;
            loadQuestion();
        }
        loadQuestion(); // Init

        // --- Feature 5 & 6 are static HTML in this demo ---

        // --- GEMINI API INTEGRATION ---
        
        function saveApiKey() {
            const key = document.getElementById('gemini-key-input').value;
            if(key) {
                currentState.apiKey = key;
                document.getElementById('api-key-banner').classList.add('hidden');
                alert("API Key Saved! AI features are now active.");
            }
        }

        async function callGemini(prompt) {
            if (!currentState.apiKey) {
                alert("Please enter a Gemini API Key in the top banner to use AI features.");
                return "Error: No API Key";
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${currentState.apiKey}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "Sorry, I encountered an error connecting to the AI. Please check your API Key.";
            }
        }

        // --- Feature 8: AI Mock Interview ---
        function startInterview() {
            const type = document.getElementById('interview-type').value;
            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML = ''; // Clear chat
            currentState.chatHistory = []; // Reset context
            
            // Initial AI Greeting
            const greeting = type === 'HR' 
                ? "Hello! I am your HR interviewer. Let's start with a classic: Tell me about yourself." 
                : "Hello. I will be conducting your Technical round. Let's begin. What is your favorite programming language and why?";
            
            appendMessage('ai', greeting);
            currentState.chatHistory.push(`System: You are a strict but helpful interviewer conducting a ${type} interview.`);
            currentState.chatHistory.push(`AI: ${greeting}`);
        }

        function appendMessage(sender, text) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = "flex items-start gap-3 " + (sender === 'user' ? "flex-row-reverse" : "");
            
            const avatar = sender === 'ai' 
                ? `<div class="w-8 h-8 rounded-full bg-primary flex-shrink-0 flex items-center justify-center text-white text-xs"><i class="fa-solid fa-robot"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-slate-600 text-xs"><i class="fa-solid fa-user"></i></div>`;
            
            const bubbleColor = sender === 'ai' ? "bg-white border border-slate-200 text-slate-700" : "bg-primary text-white";
            
            // Parse Markdown for AI responses
            const content = sender === 'ai' ? marked.parse(text) : text;

            div.innerHTML = `
                ${avatar}
                <div class="${bubbleColor} p-3 rounded-2xl ${sender === 'ai' ? 'rounded-tl-none' : 'rounded-tr-none'} text-sm shadow-sm max-w-[80%] prose prose-sm">
                    ${content}
                </div>
            `;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            // User UI
            appendMessage('user', text);
            input.value = '';
            currentState.chatHistory.push(`User: ${text}`);

            // Show Typing Indicator
            const history = document.getElementById('chat-history');
            const typingDiv = document.createElement('div');
            typingDiv.id = "typing-indicator";
            typingDiv.className = "flex items-start gap-3";
            typingDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-primary flex-shrink-0 flex items-center justify-center text-white text-xs"><i class="fa-solid fa-robot"></i></div>
                <div class="bg-white border border-slate-200 p-4 rounded-2xl rounded-tl-none shadow-sm flex gap-1">
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                </div>`;
            history.appendChild(typingDiv);
            history.scrollTop = history.scrollHeight;

            // Construct Context for API
            // We limit context to last 6 turns to save tokens/complexity
            const contextStr = currentState.chatHistory.slice(-6).join('\n');
            const prompt = `${contextStr}\n\nInstructions: Act as the interviewer. Evaluate the user's last answer briefly (be constructive), then ask the next logical interview question. Keep it conversational.`;

            // Call API
            const response = await callGemini(prompt);
            
            // Remove typing indicator & Show Response
            document.getElementById('typing-indicator').remove();
            appendMessage('ai', response);
            currentState.chatHistory.push(`AI: ${response}`);
        }

        // --- Feature 7: Resume Builder AI ---
        async function aiOptimizeResume() {
            const summaryBox = document.getElementById('resume-summary');
            const originalText = summaryBox.value;
            
            if(!originalText) {
                alert("Please write a rough draft first!");
                return;
            }

            const btn = document.querySelector('button[onclick="aiOptimizeResume()"]');
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Improving...';
            
            const prompt = `Rewrite this professional summary to be ATS-friendly, impactful, and use strong action verbs. Keep it under 60 words: "${originalText}"`;
            
            const optimized = await callGemini(prompt);
            summaryBox.value = optimized.trim(); // Update textarea
            
            btn.innerHTML = originalBtnText;
            generatePreview(); // Update preview
        }

        function generatePreview() {
            document.getElementById('prev-summary').innerText = document.getElementById('resume-summary').value || "Summary will appear here.";
            
            const skills = document.getElementById('resume-skills').value.split(',');
            const skillsContainer = document.getElementById('prev-skills');
            skillsContainer.innerHTML = '';
            skills.forEach(s => {
                if(s.trim()) {
                    const span = document.createElement('span');
                    span.className = "bg-slate-100 text-slate-700 px-2 py-1 rounded text-xs font-semibold";
                    span.innerText = s.trim();
                    skillsContainer.appendChild(span);
                }
            });
        }
    </script>
</body>
</html>
