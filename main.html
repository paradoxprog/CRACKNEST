<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrackNest | Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
        .hidden-section { display: none; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col hidden md:flex">
        <div class="h-16 flex items-center px-6 border-b border-gray-200">
            <i class="fa-solid fa-nest-dragon text-indigo-600 text-2xl mr-2"></i>
            <span class="text-xl font-bold text-gray-800">CrackNest</span>
        </div>
        
        <nav class="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
            <button onclick="showSection('profile-section')" class="sidebar-link w-full flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 active">
                <i class="fa-solid fa-user mr-3"></i> Profile Setup
            </button>
            <button onclick="showSection('baseline-section')" class="sidebar-link w-full flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100">
                <i class="fa-solid fa-clipboard-check mr-3"></i> Baseline Test
            </button>
            <button onclick="showSection('dashboard-section')" class="sidebar-link w-full flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100">
                <i class="fa-solid fa-chart-pie mr-3"></i> Training Hub
            </button>
            <button onclick="showSection('test-series-section')" class="sidebar-link w-full flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100">
                <i class="fa-solid fa-list-ol mr-3"></i> Test Series
            </button>
            <button onclick="showSection('resume-section')" class="sidebar-link w-full flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100">
                <i class="fa-solid fa-file-pdf mr-3"></i> Resume Builder
            </button>
            <button onclick="showSection('mock-interview-section')" class="sidebar-link w-full flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100">
                <i class="fa-solid fa-headset mr-3"></i> AI Mock Interview
            </button>
            <button onclick="showSection('final-eval-section')" class="sidebar-link w-full flex items-center px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100">
                <i class="fa-solid fa-award mr-3"></i> Final Evaluation
            </button>
        </nav>

        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center">
                <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">U</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-700">Student User</p>
                    <p class="text-xs text-gray-500">Free Tier</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-gray-50 p-8">
        
        <div id="api-key-banner" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded shadow-sm" role="alert">
            <p class="font-bold">Setup Required</p>
            <p>Please enter your Gemini API Key to activate AI features.</p>
            <div class="mt-2 flex">
                <input type="password" id="gemini-api-key" placeholder="Paste API Key Here" class="border p-2 rounded w-full md:w-1/2 mr-2">
                <button onclick="saveApiKey()" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">Save Key</button>
            </div>
        </div>

        <div id="profile-section" class="section-content">
            <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">3. Profile Setup</h2>
                <p class="text-gray-500 mb-6">Tell us about yourself so CrackNest can build your custom path.</p>
                
                <form id="profile-form" onsubmit="handleProfileSubmit(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="user-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Degree / Stream</label>
                            <input type="text" id="user-degree" placeholder="e.g. B.Tech CSE" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Year of Passing</label>
                            <input type="number" id="user-year" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Career Field Target</label>
                            <select id="user-field" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                <option>IT / Software</option>
                                <option>Marketing</option>
                                <option>Finance</option>
                                <option>HR</option>
                                <option>Core Engineering</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Specific Role</label>
                            <input type="text" id="user-role" placeholder="e.g. Frontend Dev" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Experience Level</label>
                            <select id="user-exp" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                <option>Fresher</option>
                                <option>0-2 Years</option>
                                <option>2+ Years</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md hover:bg-indigo-700 font-bold transition">
                        Generate My Career Plan <i class="fa-solid fa-wand-magic-sparkles ml-2"></i>
                    </button>
                </form>

                <div id="roadmap-result" class="hidden mt-8 p-6 bg-indigo-50 rounded-lg border border-indigo-100">
                    <h3 class="text-xl font-bold text-indigo-800 mb-2">Your Personalized Roadmap</h3>
                    <div id="roadmap-content" class="prose text-gray-700"></div>
                </div>
            </div>
        </div>

        <div id="baseline-section" class="section-content hidden-section">
            <div class="bg-white rounded-xl shadow p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">4. Baseline Skill Test</h2>
                <p class="mb-4 text-gray-600">This AI-generated test assesses your current level based on your profile.</p>
                <div class="flex gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded w-1/4 text-center">
                        <i class="fa-solid fa-code text-blue-500 text-2xl mb-2"></i>
                        <div class="font-bold">Technical</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded w-1/4 text-center">
                        <i class="fa-solid fa-brain text-green-500 text-2xl mb-2"></i>
                        <div class="font-bold">Aptitude</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded w-1/4 text-center">
                        <i class="fa-solid fa-comments text-yellow-500 text-2xl mb-2"></i>
                        <div class="font-bold">Verbal</div>
                    </div>
                </div>
                <button onclick="generateBaselineTest()" class="bg-indigo-600 text-white px-6 py-2 rounded shadow hover:bg-indigo-700">Start AI Assessment</button>
                
                <div id="baseline-questions" class="mt-6 hidden">
                    <div id="questions-container" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <div id="dashboard-section" class="section-content hidden-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">5. Training Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow border-t-4 border-blue-500">
                    <h3 class="font-bold text-lg mb-2">ðŸ“˜ Aptitude Training</h3>
                    <ul class="text-sm text-gray-600 space-y-2 mb-4">
                        <li><i class="fa-solid fa-check text-green-500 mr-2"></i> Quantitative Analysis</li>
                        <li><i class="fa-solid fa-check text-green-500 mr-2"></i> Logical Reasoning</li>
                        <li><i class="fa-solid fa-play-circle text-blue-500 mr-2"></i> Solution Videos</li>
                    </ul>
                    <button class="w-full text-blue-600 border border-blue-600 py-1 rounded hover:bg-blue-50">Start Module</button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow border-t-4 border-purple-500">
                    <h3 class="font-bold text-lg mb-2">ðŸ’» Technical Training</h3>
                    <p class="text-xs text-gray-400 mb-2">Customized for: <span id="dash-role-display">Software Dev</span></p>
                    <ul class="text-sm text-gray-600 space-y-2 mb-4">
                        <li><i class="fa-solid fa-laptop-code text-purple-500 mr-2"></i> Role-based Coding</li>
                        <li><i class="fa-solid fa-database text-purple-500 mr-2"></i> Domain Concepts</li>
                        <li><i class="fa-solid fa-bug text-purple-500 mr-2"></i> Debugging Drills</li>
                    </ul>
                    <button class="w-full text-purple-600 border border-purple-600 py-1 rounded hover:bg-purple-50">Start Module</button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow border-t-4 border-orange-500">
                    <h3 class="font-bold text-lg mb-2">ðŸŽ™ HR & Soft Skills</h3>
                    <ul class="text-sm text-gray-600 space-y-2 mb-4">
                        <li><i class="fa-solid fa-user-tie text-orange-500 mr-2"></i> "Tell me about yourself"</li>
                        <li><i class="fa-solid fa-envelope text-orange-500 mr-2"></i> Email Etiquette</li>
                        <li><i class="fa-solid fa-bolt text-orange-500 mr-2"></i> Confidence Building</li>
                    </ul>
                    <button class="w-full text-orange-600 border border-orange-600 py-1 rounded hover:bg-orange-50">Start Module</button>
                </div>
            </div>
        </div>

        <div id="test-series-section" class="section-content hidden-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">6. Test Series</h2>
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="border-b flex">
                    <button class="px-6 py-3 text-indigo-600 border-b-2 border-indigo-600 font-bold">Level 1: Aptitude</button>
                    <button class="px-6 py-3 text-gray-500 hover:text-indigo-600">Level 2: Technical</button>
                    <button class="px-6 py-3 text-gray-500 hover:text-indigo-600">Level 3: HR</button>
                </div>
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-lg">Comprehensive Aptitude Assessment</h3>
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Unlocked</span>
                    </div>
                    <p class="text-gray-600 mb-4">Analytics + Solution Explanations provided by Gemini AI.</p>
                    <div class="h-4 bg-gray-200 rounded-full w-full mb-2">
                        <div class="h-4 bg-indigo-500 rounded-full" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mb-4">0% Completed</p>
                    <button class="bg-indigo-600 text-white px-4 py-2 rounded">Take Test</button>
                </div>
            </div>
        </div>

        <div id="resume-section" class="section-content hidden-section">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">7. AI Resume Builder</h2>
                <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"><i class="fa-solid fa-download mr-2"></i> Export PDF</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow">
                    <h3 class="font-bold mb-4">Edit Content</h3>
                    <div class="space-y-4">
                        <textarea id="resume-summary" rows="3" class="w-full border p-2 rounded" placeholder="Professional Summary"></textarea>
                        <button onclick="optimizeResume('summary')" class="text-sm text-indigo-600 font-bold"><i class="fa-solid fa-wand-magic-sparkles"></i> Rewrite with AI</button>
                        
                        <textarea id="resume-skills" rows="3" class="w-full border p-2 rounded" placeholder="Skills (comma separated)"></textarea>
                        
                        <textarea id="resume-exp" rows="5" class="w-full border p-2 rounded" placeholder="Experience / Projects"></textarea>
                        <button onclick="optimizeResume('bullets')" class="text-sm text-indigo-600 font-bold"><i class="fa-solid fa-wand-magic-sparkles"></i> Improve Bullet Points</button>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-xl shadow border border-gray-200 min-h-[500px]">
                    <div class="text-center border-b pb-4 mb-4">
                        <h1 class="text-2xl font-bold uppercase tracking-wider">Your Name</h1>
                        <p class="text-gray-500 text-sm">email@example.com | +91 9999999999</p>
                    </div>
                    <div id="resume-ai-feedback" class="text-sm text-gray-600 italic">
                        AI Feedback will appear here...
                    </div>
                </div>
            </div>
        </div>

        <div id="mock-interview-section" class="section-content hidden-section h-full flex flex-col">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">8. AI Mock Interview</h2>
            
            <div class="flex gap-4 mb-4">
                <button onclick="startInterview('HR')" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded border border-indigo-300 hover:bg-indigo-200">Start HR Round</button>
                <button onclick="startInterview('Technical')" class="bg-purple-100 text-purple-700 px-4 py-2 rounded border border-purple-300 hover:bg-purple-200">Start Technical Round</button>
            </div>

            <div class="flex-1 bg-white rounded-xl shadow border border-gray-200 flex flex-col overflow-hidden">
                <div id="chat-history" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
                    <div class="flex items-start">
                        <div class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center flex-shrink-0 mt-1"><i class="fa-solid fa-robot"></i></div>
                        <div class="ml-3 bg-white p-3 rounded-lg shadow-sm border border-gray-100 max-w-[80%]">
                            <p class="text-gray-800">Hello! Select a mode above to start your mock interview.</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 bg-white border-t border-gray-200">
                    <div class="flex gap-2">
                        <input type="text" id="user-response" placeholder="Type your answer here..." class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button onclick="sendReply()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700"><i class="fa-solid fa-paper-plane"></i></button>
                        <button class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-200" title="Voice Input (Demo)"><i class="fa-solid fa-microphone"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="final-eval-section" class="section-content hidden-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">9. Final Evaluation</h2>
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg p-8 text-white text-center mb-8">
                <h3 class="text-lg uppercase tracking-widest opacity-80 mb-2">Interview Readiness Score</h3>
                <div class="text-6xl font-bold mb-4">--/100</div>
                <p>Complete all modules to generate your final report.</p>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
                <h3 class="font-bold text-gray-800 mb-4">Performance Breakdown</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-1"><span class="text-sm font-medium">Aptitude</span> <span class="text-sm text-gray-500">Pending</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1"><span class="text-sm font-medium">Technical Knowledge</span> <span class="text-sm text-gray-500">Pending</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1"><span class="text-sm font-medium">Communication</span> <span class="text-sm text-gray-500">Pending</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-orange-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- 1. GLOBAL STATE & CONFIG ---
        let GEMINI_API_KEY = ""; 
        let userProfile = {};
        let interviewContext = []; // Stores chat history

        // --- 2. API HANDLING ---
        function saveApiKey() {
            const input = document.getElementById('gemini-api-key').value;
            if(input) {
                GEMINI_API_KEY = input;
                document.getElementById('api-key-banner').style.display = 'none';
                alert("API Key Saved! You can now use AI features.");
            }
        }

        async function callGemini(prompt) {
            if (!GEMINI_API_KEY) {
                alert("Please enter your API Key at the top of the dashboard.");
                return "Error: No API Key";
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "Sorry, there was an error connecting to CrackNest AI.";
            }
        }

        // --- 3. NAVIGATION LOGIC ---
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden-section'));
            // Remove active class from nav
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active', 'bg-gray-100'));
            
            // Show target
            document.getElementById(sectionId).classList.remove('hidden-section');
            
            // Highlight button (simple logic for demo)
            event.currentTarget.classList.add('active');
        }

        // --- 4. PROFILE & ROADMAP LOGIC ---
        async function handleProfileSubmit(e) {
            e.preventDefault();
            
            // Collect Data
            userProfile = {
                name: document.getElementById('user-name').value,
                degree: document.getElementById('user-degree').value,
                role: document.getElementById('user-role').value,
                exp: document.getElementById('user-exp').value
            };

            // Update UI elements
            document.getElementById('dash-role-display').innerText = userProfile.role;

            // Show Loading
            const resultDiv = document.getElementById('roadmap-result');
            const contentDiv = document.getElementById('roadmap-content');
            resultDiv.classList.remove('hidden');
            contentDiv.innerHTML = '<span class="loader"></span> Generating your personalized roadmap...';

            // Create Prompt
            const prompt = `Act as CrackNest, an expert career counselor. Create a short, bulleted interview preparation roadmap for a student named ${userProfile.name} targeting the role of ${userProfile.role} with ${userProfile.exp} experience. Degree: ${userProfile.degree}. Include 3 key focus areas and a motivational quote. Format in Markdown.`;

            // Call API
            const aiResponse = await callGemini(prompt);
            
            // Render
            contentDiv.innerHTML = marked.parse(aiResponse);
        }

        // --- 5. BASELINE TEST LOGIC ---
        async function generateBaselineTest() {
            const role = userProfile.role || "Software Engineer";
            const container = document.getElementById('questions-container');
            const section = document.getElementById('baseline-questions');
            
            section.classList.remove('hidden');
            container.innerHTML = '<span class="loader"></span> Generating test for ' + role + '...';

            const prompt = `Generate 3 multiple choice questions for a ${role} interview baseline test. Return ONLY the questions, options, and denote the correct answer strictly. Do not add intro text.`;
            
            const aiResponse = await callGemini(prompt);
            container.innerHTML = marked.parse(aiResponse); // Rendering MD for simplicity
        }

        // --- 6. RESUME OPTIMIZER ---
        async function optimizeResume(type) {
            const feedbackBox = document.getElementById('resume-ai-feedback');
            let content = "";
            let prompt = "";

            if (type === 'summary') {
                content = document.getElementById('resume-summary').value;
                if(!content) return alert("Fill the summary first");
                prompt = `Rewrite this resume summary to be ATS-friendly, professional, and impactful: "${content}"`;
            } else {
                content = document.getElementById('resume-exp').value;
                if(!content) return alert("Fill experience first");
                prompt = `Improve these resume bullet points to include action verbs and measurable metrics: "${content}"`;
            }

            feedbackBox.innerHTML = '<span class="loader"></span> Analyzing...';
            const aiResponse = await callGemini(prompt);
            feedbackBox.innerHTML = marked.parse(aiResponse);
        }

        // --- 7. MOCK INTERVIEW LOGIC ---
        let currentInterviewMode = "";

        async function startInterview(mode) {
            currentInterviewMode = mode;
            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML = ''; // Clear chat
            
            // Add System Welcome
            addMessageToChat('ai', `Starting ${mode} Interview Mode. I am ready when you are. Introduce yourself to begin.`);
            
            // Reset Context
            interviewContext = [{
                role: "system",
                content: `You are an strict interviewer for a ${mode} round for the role of ${userProfile.role || 'candidate'}. Keep responses concise. Ask one question at a time.`
            }];
        }

        function addMessageToChat(sender, text) {
            const history = document.getElementById('chat-history');
            const align = sender === 'user' ? 'justify-end' : 'justify-start';
            const bg = sender === 'user' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-800 border border-gray-100';
            const icon = sender === 'user' ? 'fa-user' : 'fa-robot';
            const iconBg = sender === 'user' ? 'bg-gray-200 text-gray-600' : 'bg-indigo-600 text-white';

            const html = `
                <div class="flex items-start ${align}">
                    ${sender === 'ai' ? `<div class="${iconBg} rounded-full h-8 w-8 flex items-center justify-center flex-shrink-0 mt-1 mr-3"><i class="fa-solid ${icon}"></i></div>` : ''}
                    <div class="${bg} p-3 rounded-lg shadow-sm max-w-[80%]">
                        <p>${text}</p>
                    </div>
                    ${sender === 'user' ? `<div class="${iconBg} rounded-full h-8 w-8 flex items-center justify-center flex-shrink-0 mt-1 ml-3"><i class="fa-solid ${icon}"></i></div>` : ''}
                </div>
            `;
            history.insertAdjacentHTML('beforeend', html);
            history.scrollTop = history.scrollHeight;
        }

        async function sendReply() {
            const input = document.getElementById('user-response');
            const text = input.value;
            if (!text) return;

            // User Message
            addMessageToChat('user', text);
            input.value = '';

            // Loading state
            const history = document.getElementById('chat-history');
            const loaderId = 'loader-' + Date.now();
            history.insertAdjacentHTML('beforeend', `<div id="${loaderId}" class="text-gray-400 text-sm ml-12"><span class="loader"></span> Thinking...</div>`);

            // Context Prompt Construction
            let prompt = `Role: ${currentInterviewMode} Interviewer. Candidate Role: ${userProfile.role}. User said: "${text}". Evaluate briefly and ask the next relevant question.`;

            // Call API
            const response = await callGemini(prompt);

            // Remove loader and add AI Message
            document.getElementById(loaderId).remove();
            addMessageToChat('ai', response);
        }
    </script>
</body>
</html>
