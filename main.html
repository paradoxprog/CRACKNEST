<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrackNest | Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // Indigo 600
                        secondary: '#F59E0B', // Amber 500
                        dark: '#0F172A', // Slate 900
                        light: '#F8FAFC', // Slate 50
                        success: '#10B981', // Emerald 500
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4F46E5;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hide sections by default */
        .section-view {
            display: none;
        }
        .section-view.active {
            display: block;
            animation: fadeIn 0.4s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Specific Fade-In for chat messages */
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        .chat-bubble {
            max-width: 80%;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 1rem;
            position: relative;
            line-height: 1.5;
        }
        .chat-user {
            background-color: #4F46E5;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-ai {
            background-color: #F1F5F9;
            color: #1E293B;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }
        /* Markdown styles inside chat */
        .chat-ai ul { list-style-type: disc; margin-left: 1.5rem; }
        .chat-ai strong { font-weight: 700; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 h-screen overflow-hidden flex flex-col">

    <div id="full-page-loader" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="loader w-12 h-12 border-4 border-t-primary mb-4"></div>
        <p class="text-slate-500 font-medium animate-pulse">Initializing CrackNest...</p>
    </div>

    <div id="app-container" class="flex h-full hidden">
        
        <aside class="w-64 bg-white border-r border-slate-200 flex-col hidden md:flex z-20 shadow-sm">
            <div class="h-20 flex items-center px-6 border-b border-slate-100 cursor-pointer" onclick="window.location.reload()">
                <span class="font-heading font-bold text-2xl text-slate-800">Crack<span class="text-primary">Nest</span></span>
            </div>

            <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-1" id="sidebar-nav">
                </nav>

            <div class="p-4 border-t border-slate-100">
                <div class="flex items-center gap-3 p-2 rounded-lg bg-slate-50 mb-3 cursor-pointer hover:bg-slate-100 transition" onclick="switchView('view-profile-setup')">
                    <div id="sidebar-user-avatar" class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm shadow-md">U</div>
                    <div class="overflow-hidden">
                        <p id="sidebar-user-name" class="text-sm font-bold text-slate-700 truncate">User</p>
                        <p class="text-xs text-slate-500 truncate">View Profile</p>
                    </div>
                </div>
                <button id="logout-btn" class="w-full flex items-center justify-center gap-2 text-red-500 hover:bg-red-50 py-2 rounded-lg transition text-sm font-medium">
                    <i class="fa-solid fa-right-from-bracket"></i> Reset / Sign Out
                </button>
            </div>
        </aside>

        <div class="md:hidden fixed top-0 w-full bg-white z-20 border-b border-slate-200 h-16 flex items-center justify-between px-4 shadow-sm">
            <span class="font-heading font-bold text-xl text-slate-800">Crack<span class="text-primary">Nest</span></span>
            <button id="mobile-menu-toggle" class="text-slate-600 w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100"><i class="fa-solid fa-bars text-xl"></i></button>
        </div>

        <div id="mobile-menu" class="fixed inset-0 bg-slate-900/50 z-30 hidden md:hidden transition-opacity">
            <div class="bg-white w-4/5 h-full shadow-2xl p-4 flex flex-col transform transition-transform">
                <div class="flex justify-between items-center mb-8 border-b border-slate-100 pb-4">
                    <span class="font-heading font-bold text-xl text-primary">Menu</span>
                    <button id="close-mobile-menu" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <nav id="mobile-nav-items" class="space-y-2"></nav>
            </div>
        </div>

        <main class="flex-1 flex flex-col h-full overflow-hidden relative pt-16 md:pt-0">
            
            <div id="views-container" class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 relative scroll-smooth">

                <div id="view-profile-setup" class="section-view max-w-2xl mx-auto mt-8 pb-12">
                    <div class="bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-primary text-2xl animate-bounce">
                                <i class="fa-solid fa-user-gear"></i>
                            </div>
                            <h2 id="profile-heading" class="text-2xl font-bold text-slate-800 font-heading">Let's Set Up Your Profile</h2>
                            <p id="profile-subheading" class="text-slate-500">Tell us about yourself so we can personalize your roadmap.</p>
                        </div>

                        <form id="profile-form" class="space-y-6">
                            
                            <div class="border-b border-slate-200 pb-4">
                                <h3 class="font-bold text-lg text-slate-700 mb-3 flex items-center gap-2"><i class="fa-solid fa-user text-primary/70"></i> Personal Info</h3>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                                        <input type="text" id="p-name" required class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Degree / Stream</label>
                                        <input type="text" id="p-degree" placeholder="e.g. B.Tech Computer Science" required class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
                                    </div>
                                </div>

                                <div class="grid md:grid-cols-2 gap-6 mt-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Year of Passing</label>
                                        <select id="p-year" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary outline-none bg-white">
                                            <option>2023</option>
                                            <option>2024</option>
                                            <option selected>2025</option>
                                            <option>2026</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Languages (e.g. English, Hindi)</label>
                                        <input type="text" id="p-languages" placeholder="e.g. English, Hindi, German" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
                                    </div>
                                </div>
                                
                                <div class="mt-6">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Certifications (Comma separated)</label>
                                    <input type="text" id="p-certifications" placeholder="e.g. AWS Certified Developer, Google Analytics" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
                                </div>
                            </div>


                            <div class="pt-4">
                                <h3 class="font-bold text-lg text-slate-700 mb-3 flex items-center gap-2"><i class="fa-solid fa-bullseye text-primary/70"></i> Career Goal</h3>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Target Field</label>
                                        <select id="p-field" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary outline-none bg-white">
                                            <option value="IT/Tech">IT / Technology</option>
                                            <option value="Marketing">Marketing / Sales</option>
                                            <option value="HR">Human Resources (HR)</option>
                                            <option value="Finance">Finance / Accounting</option>
                                            <option value="Engineering">Core Engineering</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Specific Target Role</label>
                                        <input type="text" id="p-target" required placeholder="e.g. Software Developer, Financial Analyst" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Experience Level</label>
                                    <select id="p-experience" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary outline-none bg-white">
                                        <option value="Fresher">Fresher (Student)</option>
                                        <option value="Experienced">Experienced (1+ Years)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button type="submit" id="profile-submit-btn" class="w-full bg-primary text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-primary/30 flex justify-center items-center gap-2 transform hover:scale-[1.02] mt-8">
                                Save Profile & Start Baseline Test <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <div id="view-skill-test" class="section-view max-w-3xl mx-auto mt-4 pb-12">
                    <div class="bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-slate-100 pb-4 gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 font-heading">Baseline Skill Assessment</h2>
                                <p class="text-sm text-slate-500">Customized for: <span id="test-target-role" class="font-bold text-primary">Software Developer</span></p>
                            </div>
                            <div class="bg-indigo-50 text-primary px-4 py-1.5 rounded-full text-sm font-bold flex items-center gap-2">
                                <i class="fa-solid fa-brain"></i> AI Generated
                            </div>
                        </div>

                        <div id="test-loading" class="text-center py-16">
                            <div class="loader mx-auto mb-6 border-t-secondary w-12 h-12"></div>
                            <h3 class="text-lg font-bold text-slate-700 mb-2">Generating Questions...</h3>
                            <p class="text-slate-500 animate-pulse max-w-md mx-auto">Our AI is analyzing your profile to create relevant questions for your role.</p>
                        </div>

                        <div id="test-container" class="space-y-6 hidden">
                            </div>

                        <div id="test-results" class="hidden text-center py-8">
                            <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600 text-4xl shadow-sm">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-slate-800 mb-3 font-heading">All Done!</h3>
                            <p class="text-slate-600 mb-8 text-lg">We've analyzed your performance and built your custom roadmap.</p>
                            
                            <div class="bg-white p-6 rounded-xl text-left mb-8 border border-slate-200 shadow-sm relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-primary"></div>
                                <h4 class="font-bold text-sm text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="fa-solid fa-robot"></i> AI Analysis Report</h4>
                                <div id="test-analysis-text" class="prose prose-slate text-slate-700"></div>
                            </div>

                            <button id="go-to-dashboard-btn" class="bg-primary text-white font-bold py-4 px-10 rounded-xl hover:bg-indigo-700 transition shadow-xl shadow-primary/30 transform hover:scale-105">
                                Go to Dashboard <i class="fa-solid fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="view-dashboard" class="section-view pb-12">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-slate-800 font-heading">Welcome Back, <span id="dash-username" class="text-primary">User</span>! ðŸ‘‹</h1>
                            <p class="text-slate-500">Your daily learning hub is ready.</p>
                        </div>
                        <div class="flex gap-3">
                            <div class="bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 flex items-center gap-2 hidden">
                                <i class="fa-solid fa-fire text-orange-500"></i>
                                <span class="font-bold text-slate-700">1 Day Streak</span>
                            </div>
                            <div class="bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 flex items-center gap-2 hidden">
                                <i class="fa-solid fa-star text-yellow-500"></i>
                                <span class="font-bold text-slate-700">Level 1</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-4">
                                <div class="bg-blue-100 p-3 rounded-lg text-blue-600"><i class="fa-solid fa-chart-pie text-xl"></i></div>
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">Readiness</span>
                            </div>
                            <h3 id="dash-readiness-percent" class="text-3xl font-bold text-slate-800 mb-1">0%</h3>
                            <div class="w-full bg-slate-100 rounded-full h-2 mt-2">
                                <div id="dash-readiness-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-4">
                                <div class="bg-purple-100 p-3 rounded-lg text-purple-600"><i class="fa-solid fa-bullseye text-xl"></i></div>
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">Target</span>
                            </div>
                            <h3 id="dash-target-role" class="text-xl font-bold text-slate-800 mb-1">Developer</h3>
                            <p class="text-sm text-slate-500">Field: <span id="dash-target-field">IT/Tech</span></p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-4">
                                <div class="bg-emerald-100 p-3 rounded-lg text-emerald-600"><i class="fa-solid fa-check-circle text-xl"></i></div>
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">Modules</span>
                            </div>
                            <h3 id="dash-modules-complete" class="text-3xl font-bold text-slate-800 mb-1">0/5</h3>
                            <p id="dash-modules-status" class="text-sm text-slate-500">Status: Incomplete</p>
                        </div>
                    </div>

                    <div class="grid lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2"><i class="fa-solid fa-map text-secondary"></i> Personalized Roadmap</h3>
                                <button class="text-primary text-sm font-medium hover:underline">View Full Plan</button>
                            </div>
                            <div id="roadmap-container" class="space-y-4">
                                <div class="animate-pulse space-y-3">
                                    <div class="h-20 bg-slate-50 border border-slate-100 rounded-lg"></div>
                                    <div class="h-20 bg-slate-50 border border-slate-100 rounded-lg"></div>
                                    <div class="h-20 bg-slate-50 border border-slate-100 rounded-lg"></div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="bg-gradient-to-br from-primary to-indigo-700 rounded-xl p-6 text-white shadow-xl relative overflow-hidden group">
                                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full group-hover:scale-150 transition duration-500"></div>
                                <h3 class="font-bold text-lg mb-2"><i class="fa-solid fa-robot mr-2"></i> AI Mock Interview</h3>
                                <p class="text-indigo-100 text-sm mb-6">Practice with our AI HR to boost your confidence before the real deal.</p>
                                <button onclick="switchView('view-mock-interview')" class="w-full bg-white text-primary font-bold py-3 rounded-lg hover:bg-indigo-50 transition shadow-lg">Start Session</button>
                            </div>

                            <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                                <h3 class="font-bold text-lg text-slate-800 mb-4">Daily Challenge</h3>
                                <div class="bg-orange-50 border border-orange-100 rounded-lg p-4 mb-4">
                                    <span class="text-xs font-bold text-orange-600 uppercase tracking-wide" id="daily-challenge-topic">APTITUDE</span>
                                    <p class="font-medium text-slate-800 mt-1" id="daily-challenge-problem">Time & Work Problem</p>
                                </div>
                                <button class="w-full border border-slate-200 text-slate-600 font-medium py-2 rounded-lg hover:bg-slate-50 transition">Solve Now</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-mock-interview" class="section-view h-full flex flex-col pb-4">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 font-heading">AI Mock Interview</h2>
                            <p class="text-slate-500">Practice HR and Technical rounds in a safe environment.</p>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto">
                             <select id="interview-mode" class="flex-1 sm:flex-none border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white focus:ring-primary focus:border-primary">
                                <option value="HR">HR Round</option>
                                <option value="Technical">Technical Round</option>
                            </select>
                            <button id="start-interview-btn" class="bg-primary text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition shadow-lg shadow-primary/20 whitespace-nowrap">Start Session</button>
                        </div>
                    </div>

                    <div class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden relative">
                        <div id="chat-history" class="flex-1 overflow-y-auto p-6 bg-slate-50 space-y-4">
                            <div class="flex items-center justify-center h-full text-slate-400 flex-col">
                                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4 text-slate-300 text-3xl">
                                    <i class="fa-solid fa-headset"></i>
                                </div>
                                <p class="font-medium">Select a mode and click 'Start Session' to begin.</p>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-white border-t border-slate-200">
                            <form id="chat-form" class="flex gap-3">
                                <input type="text" id="chat-input" placeholder="Type your answer here..." disabled class="flex-1 border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-primary focus:border-primary outline-none disabled:bg-slate-50 disabled:text-slate-400 transition">
                                <button type="submit" id="send-chat-btn" disabled class="bg-primary text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
                                    <i class="fa-solid fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="view-resume" class="section-view pb-12">
                    <h2 class="text-2xl font-bold text-slate-800 font-heading mb-6">Smart Resume Builder</h2>
                    
                    <div class="grid lg:grid-cols-2 gap-8">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fa-solid fa-pen-to-square text-primary"></i> Edit Details</h3>
                            <form class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Professional Summary</label>
                                    <textarea rows="4" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-primary focus:border-primary" placeholder="Passionate developer..."></textarea>
                                    <button type="button" class="text-xs text-primary font-bold mt-2 hover:underline flex items-center gap-1"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Enhance Summary</button>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Skills (Comma separated)</label>
                                    <input type="text" class="w-full border border-slate-300 rounded-lg p-2 focus:ring-primary focus:border-primary" placeholder="Java, Python, SQL...">
                                </div>
                                <div>
                                     <label class="block text-sm font-medium text-slate-700 mb-1">Experience</label>
                                     <div class="border border-slate-200 rounded-lg p-3 bg-slate-50 text-sm text-slate-500 italic">
                                        Imported from Profile
                                     </div>
                                </div>
                                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-100 text-sm text-yellow-800">
                                    <i class="fa-solid fa-lightbulb mr-2"></i> <strong>Tip:</strong> Add measurable metrics (e.g., "Improved speed by 20%") to your experience.
                                </div>
                            </form>
                        </div>

                        <div class="bg-slate-200 rounded-xl p-8 flex items-center justify-center min-h-[400px] border border-slate-300 relative">
                            <div class="text-center text-slate-500">
                                <i class="fa-solid fa-file-pdf text-5xl mb-4 text-slate-400"></i>
                                <h4 class="font-bold text-slate-600 text-lg">Live Preview</h4>
                                <p class="text-sm mb-6">Fill in details to see your resume.</p>
                                <button class="bg-slate-800 text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:bg-slate-700 transition shadow-lg">Download PDF</button>
                            </div>
                        </div>
                    </div>
                </div>

                 <div id="view-training" class="section-view pb-12">
                    <h2 class="text-2xl font-bold text-slate-800 font-heading mb-6">Training Center</h2>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 hover:shadow-lg transition cursor-pointer group">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 text-xl group-hover:scale-110 transition">
                                    <i class="fa-solid fa-calculator"></i>
                                </div>
                                <span class="bg-blue-50 text-blue-600 text-xs font-bold px-2 py-1 rounded">Level 1</span>
                            </div>
                            <h3 class="font-bold text-lg text-slate-800 mb-1">Quantitative Aptitude</h3>
                            <p class="text-slate-500 text-sm mb-4">Master speed math, percentages, and profit & loss.</p>
                            <div class="w-full bg-slate-100 h-2 rounded-full mb-2">
                                <div class="bg-blue-500 h-2 rounded-full w-1/3"></div>
                            </div>
                            <span class="text-xs text-slate-400 font-bold">33% Complete</span>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 hover:shadow-lg transition cursor-pointer group">
                             <div class="flex justify-between items-start mb-4">
                                <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center text-primary text-xl group-hover:scale-110 transition">
                                    <i class="fa-solid fa-code"></i>
                                </div>
                                <span class="bg-indigo-50 text-primary text-xs font-bold px-2 py-1 rounded">Level 2</span>
                            </div>
                            <h3 class="font-bold text-lg text-slate-800 mb-1">Technical Domain (SDE)</h3>
                            <p class="text-slate-500 text-sm mb-4">Data Structures, Algorithms, and DBMS basics.</p>
                            <div class="w-full bg-slate-100 h-2 rounded-full mb-2">
                                <div class="bg-primary h-2 rounded-full w-1/12"></div>
                            </div>
                            <span class="text-xs text-slate-400 font-bold">8% Complete</span>
                        </div>
                    </div>
                </div>

                <div id="view-test-series" class="section-view pb-12">
                    <h2 class="text-2xl font-bold text-slate-800 font-heading mb-6 flex items-center gap-2"><i class="fa-solid fa-list-ol text-primary"></i> Structured Preparation Path</h2>
                    <p class="text-slate-500 max-w-2xl mb-8">Follow this three-level testing series customized for your career target to ensure you are fully interview-ready. Target Role: <span class="font-bold text-primary" id="test-series-role"></span></p>
                    
                    <div id="level-test-area" class="bg-white rounded-xl shadow-xl p-8 border border-slate-100 hidden">
                        <div id="level-test-loading" class="text-center py-16">
                            <div class="loader mx-auto mb-6 border-t-secondary w-12 h-12"></div>
                            <h3 class="text-lg font-bold text-slate-700 mb-2">Generating <span id="loading-level"></span> Questions...</h3>
                            <p class="text-slate-500 animate-pulse max-w-md mx-auto">Our AI is fetching questions for your role: <span id="loading-role" class="font-medium text-primary"></span></p>
                        </div>
                        <div id="level-test-questions" class="space-y-6 hidden">
                            </div>
                        <div id="level-test-results" class="hidden text-center py-8">
                            <h3 class="text-3xl font-bold text-slate-800 mb-4 font-heading" id="results-heading"></h3>
                            <div class="bg-white p-6 rounded-xl text-left mb-8 border-t-4 border-red-500 shadow-sm relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                                <h4 class="font-bold text-sm text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="fa-solid fa-magnifying-glass-chart"></i> Detailed Feedback</h4>
                                <div id="results-feedback-text" class="prose prose-slate text-slate-700"></div>
                            </div>
                             <button onclick="switchView('view-test-series')" class="bg-slate-500 text-white font-bold py-3 px-8 rounded-xl hover:bg-slate-600 transition shadow-lg mt-4">
                                Back to Test Levels
                            </button>
                        </div>
                    </div>

                    <div id="level-selection-area" class="space-y-6">
                        <div class="bg-white rounded-xl shadow-lg border-t-4 border-blue-500 p-6">
                            <h3 class="text-xl font-bold text-slate-800 font-heading mb-2 flex items-center gap-2"><i class="fa-solid fa-shuffle text-blue-500"></i> Level 1: Aptitude Test</h3>
                            <p class="text-slate-600 mb-4">Focuses on core abilities like Quantitative Aptitude, Logical Reasoning, and Verbal Ability.</p>
                            <ul class="list-disc pl-5 text-sm text-slate-500 mb-4 space-y-1">
                                <li>**Analytics**: Detailed score breakdown by topic.</li>
                                <li>**Explanations**: Step-by-step solutions for every question.</li>
                            </ul>
                            <button onclick="startLevelTest('Level 1', 'Aptitude')" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition shadow-md">
                                Start Aptitude Test <i class="fa-solid fa-arrow-right ml-2"></i>
                            </button>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg border-t-4 border-primary p-6">
                            <h3 class="text-xl font-bold text-slate-800 font-heading mb-2 flex items-center gap-2"><i class="fa-solid fa-microchip text-primary"></i> Level 2: Technical Test</h3>
                            <p class="text-slate-600 mb-4">Role-based assessment covering domain-specific knowledge and practical skills for a <span class="font-bold text-primary" id="test-series-role-level2">Software Developer</span>.</p>
                            <ul class="list-disc pl-5 text-sm text-slate-500 mb-4 space-y-1">
                                <li>**MCQs**: Multiple Choice Questions tailored to your target role.</li>
                                <li>**Coding Tasks**: Hands-on problems (for technical roles) with real-time feedback.</li>
                            </ul>
                            <button onclick="startLevelTest('Level 2', 'Technical')" class="bg-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition shadow-md">
                                Start Technical Test <i class="fa-solid fa-arrow-right ml-2"></i>
                            </button>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg border-t-4 border-yellow-500 p-6">
                            <h3 class="text-xl font-bold text-slate-800 font-heading mb-2 flex items-center gap-2"><i class="fa-solid fa-handshake text-yellow-500"></i> Level 3: HR Test</h3>
                            <p class="text-slate-600 mb-4">Simulates the final interview round, testing soft skills, situational judgment, and communication.</p>
                            <ul class="list-disc pl-5 text-sm text-slate-500 mb-4 space-y-1">
                                <li>**Scenario-Based Questions**: Behavioral and situational queries.</li>
                                <li>**Written/Audio Answers**: Practice providing structured responses.</li>
                            </ul>
                            <button onclick="switchView('view-mock-interview')" class="bg-yellow-500 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-yellow-600 transition shadow-md">
                                Practice HR Round <i class="fa-solid fa-microphone-lines ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>


            </div>
        </main>
    </div>

    <script>
        // State Variables
        let userProfile = null;
        let activeTestQuestions = [];

        // --- GEMINI API HELPERS ---
        // !!! IMPORTANT: REPLACE "AIzaSyC0inV4Bpo3iG-36QKQCM-rKOFfX6Z1k3A" WITH YOUR ACTUAL GEMINI API KEY !!!
        const GEMINI_API_KEY = "AIzaSyBfO_k3iJ-n8_cQHNPuKkyXsYL5E_1d95g"; 
        // FIX: Changed model name to standard 'gemini-2.5-flash'
        const MODEL_NAME = "gemini-2.0-flash"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`;

        async function callGemini(prompt) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "AIzaSyC0inV4Bpo3iG-36QKQCM-rKOFfX6Z1k3A") {
                console.error("Gemini Error: API Key is missing or invalid. Using dummy data.");
                // Provide dummy content if key is missing to allow UI testing
                if (prompt.includes("Generate 5 multiple choice questions")) {
                    return `[{"question": "What is the capital of France? (DUMMY)", "options": ["Berlin", "Madrid", "Paris", "Rome"], "correctIndex": 2}, {"question": "What is the primary data structure for LIFO access?", "options": ["Queue", "Stack", "Array", "Heap"], "correctIndex": 1}, {"question": "Which accounting principle governs revenue recognition?", "options": ["Matching", "Cost", "Revenue recognition", "Conservatism"], "correctIndex": 2}, {"question": "What is 15% of 200?", "options": ["20", "30", "40", "50"], "correctIndex": 1}, {"question": "Which of these is a programming language?", "options": ["HTML", "CSS", "Python", "XML"], "correctIndex": 2}]`;
                }
                if (prompt.includes("Generate a brief, encouraging analysis")) {
                    return "### Dummy Analysis\n* You scored 2/5 (40%). Keep practicing!\n* You need to focus on core concepts in your chosen role.\n* Tip: Review fundamental terminology and definitions.";
                }
                // DUMMY ROADMAP RESPONSE
                if (prompt.includes("Create a 3-step learning roadmap")) {
                     const roleMatch = prompt.match(/Create a 3-step learning roadmap \(JSON\) for a (.*)\./);
                     const role = roleMatch ? roleMatch[1] : "Developer";
                     return `[{"title": "Phase 1: Foundations in ${role} Fundamentals", "description": "Master the core principles and tools essential for the ${role} position. Focus on theoretical knowledge and basic skill acquisition.", "duration": "4 Weeks"}, {"title": "Phase 2: Project Implementation & Technical Deep Dive", "description": "Apply foundational skills to a simulated project. For a ${role}, this means complex problem-solving and tool integration.", "duration": "6 Weeks"}, {"title": "Phase 3: Interview Preparation & Soft Skills", "description": "High-intensity mock interviews, behavioral scenario training, and advanced communication workshops tailored for the ${role} career path.", "duration": "3 Weeks"}]`;
                }
                // DUMMY DAILY CHALLENGE RESPONSE
                 if (prompt.includes("Generate a daily aptitude challenge")) {
                    return `{"topic": "Time & Work Problem", "problem": "If 5 workers can build a wall in 10 days, how long will it take 8 workers to build the same wall, assuming they work at the same rate?"}`;
                }
                return null;
            }
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                const data = await response.json();
                // Basic check for error structure from API
                if (data.error) {
                    console.error("Gemini API Error:", data.error.message);
                    return null;
                }
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini Network Error:", error);
                return null;
            }
        }

        // --- INITIALIZATION ---
        function initApp() {
            const storedProfile = localStorage.getItem('cracknest_profile');
            
            if (storedProfile) {
                userProfile = JSON.parse(storedProfile);
                
                // Initialize new metrics if they don't exist
                if (userProfile.readinessScore === undefined) {
                    userProfile.readinessScore = 0;
                    userProfile.modulesComplete = userProfile.baselineTestComplete ? 1 : 0;
                }

                updateSidebarUserInfo();
                handleNavigationState();
            } else {
                userProfile = null;
                switchView('view-profile-setup');
                document.getElementById('full-page-loader').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
            }
        }

        function updateSidebarUserInfo() {
            if (userProfile) {
                document.getElementById('sidebar-user-name').textContent = userProfile.name;
                document.getElementById('dash-username').textContent = userProfile.name;
                document.getElementById('sidebar-user-avatar').textContent = userProfile.name[0].toUpperCase();
            }
        }

        // --- NAVIGATION STATE MACHINE ---
        function handleNavigationState() {
            const loader = document.getElementById('full-page-loader');
            const container = document.getElementById('app-container');

            if (!userProfile) {
                switchView('view-profile-setup');
            } else if (!userProfile.baselineTestComplete) {
                // CRITICAL PATH: Loads Test if profile exists but test is incomplete
                switchView('view-skill-test');
                document.getElementById('test-target-role').textContent = userProfile.targetRole;
                loadSkillTest();
            } else {
                switchView('view-dashboard');
                loadDashboardData();
            }

            loader.classList.add('hidden');
            container.classList.remove('hidden');
            renderSidebar();
        }

        // --- VIEW SWITCHER ---
        window.switchView = function(viewId) {
            // 1. Hide ALL sections
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            
            // 2. Show TARGET section
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
            } else {
                console.error(`View ID ${viewId} not found.`);
            }
            
            window.scrollTo(0,0);
            
            // 3. Highlight sidebar item
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.dataset.target === viewId) el.classList.add('bg-indigo-50', 'text-primary');
                else el.classList.remove('bg-indigo-50', 'text-primary');
            });

            if (viewId === 'view-profile-setup' && userProfile) {
                loadProfileForEdit();
            }
            
            // 4. Specific logic for Test Series View: Reset to level selection
            if (viewId === 'view-test-series' && userProfile) {
                document.getElementById('test-series-role').textContent = userProfile.targetRole;
                document.getElementById('test-series-role-level2').textContent = userProfile.targetRole;
                document.getElementById('level-selection-area').classList.remove('hidden');
                document.getElementById('level-test-area').classList.add('hidden');
            }

            document.getElementById('mobile-menu').classList.add('hidden');
        }

        // --- SIDEBAR RENDERER ---
        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            const items = [
                { id: 'view-dashboard', icon: 'fa-table-columns', label: 'Dashboard' },
                { id: 'view-test-series', icon: 'fa-list-ol', label: 'Test Series' },
                { id: 'view-training', icon: 'fa-book-open', label: 'Training Center' },
                { id: 'view-mock-interview', icon: 'fa-headset', label: 'AI Mock Interview' },
                { id: 'view-resume', icon: 'fa-file-lines', label: 'Resume Builder' },
                { id: 'view-profile-setup', icon: 'fa-user', label: 'My Profile' }, 
            ];

            const html = items.map(item => `
                <button onclick="switchView('${item.id}')" data-target="${item.id}" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-600 font-medium rounded-lg hover:bg-slate-50 transition mb-1 text-left">
                    <i class="fa-solid ${item.icon} w-6 text-center"></i> ${item.label}
                </button>
            `).join('');

            nav.innerHTML = html;
            document.getElementById('mobile-nav-items').innerHTML = html;
        }

        // --- 1. PROFILE SETUP / EDIT LOGIC ---
        
        function loadProfileForEdit() {
            // Change Text to indicate Edit Mode
            document.getElementById('profile-heading').textContent = "Edit Your Profile";
            document.getElementById('profile-subheading').textContent = "Update your personal details and career goals.";
            document.getElementById('profile-submit-btn').innerHTML = 'Update Profile <i class="fa-solid fa-check ml-2"></i>';
            
            // Populate Fields
            document.getElementById('p-name').value = userProfile.name;
            document.getElementById('p-degree').value = userProfile.degree;
            document.getElementById('p-year').value = userProfile.year;
            document.getElementById('p-languages').value = userProfile.languages;
            document.getElementById('p-certifications').value = userProfile.certifications;
            document.getElementById('p-field').value = userProfile.targetField;
            document.getElementById('p-target').value = userProfile.targetRole; // Populate text input
            document.getElementById('p-experience').value = userProfile.experience;
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('profile-submit-btn');
            const originalText = btn.innerHTML;
            const isUpdate = !!userProfile;

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            const targetRoleInput = document.getElementById('p-target').value.trim();
            if (!targetRoleInput) {
                 alert("Please enter a Specific Target Role.");
                 btn.innerHTML = originalText;
                 btn.disabled = false;
                 return;
            }

            const profileData = {
                name: document.getElementById('p-name').value,
                degree: document.getElementById('p-degree').value,
                year: document.getElementById('p-year').value,
                languages: document.getElementById('p-languages').value,
                certifications: document.getElementById('p-certifications').value,
                targetField: document.getElementById('p-field').value,
                targetRole: targetRoleInput, // Get value from text input
                experience: document.getElementById('p-experience').value,
                // New metrics for the dashboard
                readinessScore: isUpdate && userProfile.readinessScore !== undefined ? userProfile.readinessScore : 0,
                modulesComplete: isUpdate && userProfile.modulesComplete !== undefined ? userProfile.modulesComplete : 0,
                // Ensure baselineTestComplete is false for a NEW profile submission
                baselineTestComplete: isUpdate ? userProfile.baselineTestComplete : false,
                testDate: isUpdate ? userProfile.testDate : null,
                createdAt: isUpdate ? userProfile.createdAt : new Date().toISOString()
            };

            try {
                // Save to LocalStorage
                localStorage.setItem('cracknest_profile', JSON.stringify(profileData));
                userProfile = profileData;
                
                updateSidebarUserInfo();

                if (isUpdate) {
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Updated Successfully';
                    btn.classList.add('bg-green-600', 'hover:bg-green-700');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        btn.disabled = false;
                    }, 2000);
                } else {
                    // New setup -> Start Baseline Test via navigation state
                    handleNavigationState(); 
                }

            } catch (error) {
                console.error("Error saving profile:", error);
                alert("Failed to save profile: " + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // --- 2. BASELINE SKILL TEST LOGIC ---
        let currentQuestions = [];

        async function loadSkillTest() {
            const container = document.getElementById('test-container');
            const loading = document.getElementById('test-loading');
            
            // Reset state
            container.classList.add('hidden');
            document.getElementById('test-results').classList.add('hidden');
            loading.classList.remove('hidden');
            
            // Update role display
            document.getElementById('test-target-role').textContent = userProfile.targetRole;

            // Check LocalStorage cache first
            const cacheKey = 'cracknest_questions_' + userProfile.targetRole;
            const cachedQuestions = localStorage.getItem(cacheKey);
            
            if (cachedQuestions) {
                currentQuestions = JSON.parse(cachedQuestions);
                loading.classList.add('hidden');
                renderQuestions();
            } else {
                
                const prompt = `Generate 5 multiple choice questions (JSON format) for a baseline assessment for a ${userProfile.targetRole} role. 
                Include 'question', 'options' (array of 4 strings), and 'correctIndex' (0-3). 
                Output ONLY valid JSON array. No code blocks.`;

                const result = await callGemini(prompt);
                
                if (result) {
                    try {
                        const jsonStr = result.replace(/```json/g, '').replace(/```/g, '').trim();
                        currentQuestions = JSON.parse(jsonStr);
                        // Save to LocalStorage
                        localStorage.setItem(cacheKey, JSON.stringify(currentQuestions));
                        loading.classList.add('hidden');
                        renderQuestions();
                    } catch (e) {
                        console.error("JSON Parse error", e);
                        loading.classList.add('hidden');
                        container.innerHTML = '<div class="text-center p-4 bg-red-50 text-red-600 rounded-lg">Failed to load test. AI response error. Check console.</div>';
                        container.classList.remove('hidden');
                    }
                } else {
                    loading.classList.add('hidden');
                    container.innerHTML = '<div class="text-center p-4 bg-red-50 text-red-600 rounded-lg">Failed to load test. API call failed. Check console and API key.</div>';
                    container.classList.remove('hidden');
                }
            }
        }

        function renderQuestions() {
            const container = document.getElementById('test-container');
            container.innerHTML = currentQuestions.map((q, i) => `
                <div class="p-6 bg-slate-50 rounded-xl border border-slate-200 shadow-sm transition hover:shadow-md">
                    <p class="font-bold text-slate-800 mb-4 text-lg"><span class="text-primary mr-2">Q${i+1}.</span> ${q.question}</p>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-4 bg-white rounded-lg border border-slate-200 cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition group">
                            <input type="radio" name="q${i}" value="0" class="w-5 h-5 text-primary border-slate-300 focus:ring-primary" required>
                            <span class="text-slate-700 font-medium group-hover:text-primary">${q.options[0]}</span>
                        </label>
                        <label class="flex items-center gap-3 p-4 bg-white rounded-lg border border-slate-200 cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition group">
                            <input type="radio" name="q${i}" value="1" class="w-5 h-5 text-primary border-slate-300 focus:ring-primary">
                            <span class="text-slate-700 font-medium group-hover:text-primary">${q.options[1]}</span>
                        </label>
                        <label class="flex items-center gap-3 p-4 bg-white rounded-lg border border-slate-200 cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition group">
                            <input type="radio" name="q${i}" value="2" class="w-5 h-5 text-primary border-slate-300 focus:ring-primary">
                            <span class="text-slate-700 font-medium group-hover:text-primary">${q.options[2]}</span>
                        </label>
                        <label class="flex items-center gap-3 p-4 bg-white rounded-lg border border-slate-200 cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition group">
                            <input type="radio" name="q${i}" value="3" class="w-5 h-5 text-primary border-slate-300 focus:ring-primary">
                            <span class="text-slate-700 font-medium group-hover:text-primary">${q.options[3]}</span>
                        </label>
                    </div>
                </div>
            `).join('') + `
                <button onclick="submitTest()" class="w-full bg-primary text-white font-bold py-4 rounded-xl hover:bg-indigo-700 transition shadow-lg mt-4 text-lg">
                    Submit Assessment
                </button>
            `;
            
            container.classList.remove('hidden');

            // Expose function globally
            window.submitTest = async () => {
                const btn = document.querySelector('#test-container button');
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analyzing Results...';
                btn.disabled = true;
                
                let correctCount = 0;
                const totalQuestions = currentQuestions.length;
                let incorrectDetails = [];
                
                // 1. Grade the test
                currentQuestions.forEach((q, i) => {
                    const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
                    const userAnswer = selectedOption ? parseInt(selectedOption.value) : -1;
                    const isCorrect = userAnswer === q.correctIndex;
                    
                    if (isCorrect) {
                        correctCount++;
                    } else {
                        incorrectDetails.push({
                            question: q.question
                        });
                    }
                });

                const readinessScore = Math.round((correctCount / totalQuestions) * 100);
                
                // 2. Update Local State with Score and Completion
                userProfile.baselineTestComplete = true;
                userProfile.readinessScore = readinessScore;
                userProfile.modulesComplete = 1; // Baseline is module 1
                userProfile.testDate = new Date().toISOString();
                localStorage.setItem('cracknest_profile', JSON.stringify(userProfile)); 

                // 3. Generate Feedback Prompt
                const incorrectTopics = incorrectDetails.map(d => d.question).slice(0, 3).join(" | "); // Limit topics for brevity
                const analysisPrompt = `A student aiming for ${userProfile.targetRole} just scored ${readinessScore}% (${correctCount}/${totalQuestions}) on a baseline test. 
                They missed questions related to: [${incorrectTopics}]. 
                Generate a brief, encouraging analysis (3 bullet points) on their performance, mentioning areas of weakness (if any) and a 1-sentence motivation. Format in Markdown.`;

                // 4. Get Analysis
                const analysis = await callGemini(analysisPrompt);
                
                // 5. Show Results UI
                document.getElementById('test-container').classList.add('hidden');
                document.getElementById('test-results').classList.remove('hidden');
                document.getElementById('test-analysis-text').innerHTML = marked.parse(analysis || "Great job! Your roadmap is ready.");
                
                // Pre-fetch roadmap
                loadDashboardData(true);
            };
        }
        
        document.getElementById('go-to-dashboard-btn').addEventListener('click', () => {
             handleNavigationState();
        });

        // --- 3. DASHBOARD LOGIC ---
        async function loadDashboardData(prefetch = false) {
            document.getElementById('dash-target-role').textContent = userProfile.targetRole;
            document.getElementById('dash-target-field').textContent = userProfile.targetField;

            // Update Readiness Card
            const readiness = userProfile.readinessScore || 0;
            document.getElementById('dash-readiness-percent').textContent = `${readiness}%`;
            document.getElementById('dash-readiness-bar').style.width = `${readiness}%`;

            // Update Modules Card
            const modules = userProfile.modulesComplete || 0;
            document.getElementById('dash-modules-complete').textContent = `${modules}/5`;
            document.getElementById('dash-modules-status').textContent = modules > 0 ? 'Status: Baseline Completed' : 'Status: Incomplete';
            
            // Generate/Load Daily Challenge
            if (!prefetch) {
                await loadDailyChallenge();
            }

            // Check cache for Roadmap
            const cachedRoadmap = localStorage.getItem('cracknest_roadmap_' + userProfile.targetRole);
            
            if (cachedRoadmap) {
                if(!prefetch) renderRoadmap(JSON.parse(cachedRoadmap));
            } else {
                const prompt = `Create a 3-step learning roadmap (JSON) for a ${userProfile.targetRole}. 
                Format: Array of objects with 'title', 'description', 'duration'. Output ONLY JSON array. No code blocks.`;
                
                const result = await callGemini(prompt);
                if (result) {
                    try {
                        const jsonStr = result.replace(/```json/g, '').replace(/```/g, '').trim();
                        const roadmap = JSON.parse(jsonStr);
                        localStorage.setItem('cracknest_roadmap_' + userProfile.targetRole, JSON.stringify(roadmap));
                        if(!prefetch) renderRoadmap(roadmap);
                    } catch(e) { 
                        console.error("Roadmap JSON Parse Error:", e);
                        // Fallback to show placeholder on error
                        if (!prefetch) {
                             document.getElementById('roadmap-container').innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-lg">Failed to load personalized roadmap. Please try updating your profile.</div>`;
                        }
                    }
                } else {
                     // Fallback for API failure
                    if (!prefetch) {
                        document.getElementById('roadmap-container').innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-lg">Failed to load personalized roadmap due to API error. Check key/console.</div>`;
                    }
                }
            }
        }

        function renderRoadmap(items) {
            const container = document.getElementById('roadmap-container');
            container.innerHTML = items.map((item, i) => `
                <div class="flex gap-4 p-5 rounded-xl bg-slate-50 border border-slate-100 items-start hover:bg-white hover:shadow-md transition">
                    <div class="bg-indigo-100 text-primary w-10 h-10 rounded-lg flex items-center justify-center font-bold flex-shrink-0 text-lg">${i+1}</div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-slate-800 text-lg">${item.title}</h4>
                            <span class="text-xs font-semibold text-secondary bg-orange-50 px-2 py-1 rounded border border-orange-100 whitespace-nowrap ml-2"><i class="fa-regular fa-clock"></i> ${item.duration}</span>
                        </div>
                        <p class="text-sm text-slate-600 mt-1 leading-relaxed">${item.description}</p>
                    </div>
                </div>
            `).join('');
        }
        
        // --- 5. DAILY CHALLENGE LOGIC ---
        function getTodayDateKey() {
            const today = new Date();
            // This ensures the key changes once per day
            return `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
        }

        async function loadDailyChallenge() {
            const dateKey = getTodayDateKey();
            const challengeCacheKey = `cracknest_daily_challenge_${dateKey}`;
            const cachedChallenge = localStorage.getItem(challengeCacheKey);
            
            const topicEl = document.getElementById('daily-challenge-topic');
            const problemEl = document.getElementById('daily-challenge-problem');

            if (cachedChallenge) {
                const challenge = JSON.parse(cachedChallenge);
                topicEl.textContent = challenge.topic.toUpperCase();
                problemEl.textContent = challenge.problem;
            } else {
                topicEl.textContent = "Loading...";
                problemEl.textContent = "Generating a new challenge...";

                const prompt = `Generate a daily aptitude challenge (JSON) relevant to a candidate aiming for a ${userProfile.targetRole} role. 
                The problem should focus on a universal aptitude skill like Math, Logic, or Reasoning. 
                Output ONLY JSON object with 'topic' (e.g., 'Time & Work', 'Financial Ratios') and 'problem' (the full question).`;

                const result = await callGemini(prompt);
                
                if (result) {
                    try {
                        const jsonStr = result.replace(/```json/g, '').replace(/```/g, '').trim();
                        const challenge = JSON.parse(jsonStr);

                        // Cache the result for the rest of the day
                        localStorage.setItem(challengeCacheKey, JSON.stringify(challenge));

                        topicEl.textContent = challenge.topic.toUpperCase();
                        problemEl.textContent = challenge.problem;
                    } catch (e) {
                        console.error("Daily Challenge JSON Parse Error:", e);
                        topicEl.textContent = "ERROR";
                        problemEl.textContent = "Failed to generate challenge.";
                    }
                } else {
                    topicEl.textContent = "APTITUDE";
                    problemEl.textContent = "Try a classic: Ratios & Proportions.";
                }
            }
        }


        // --- 4. AI MOCK INTERVIEW LOGIC (Unchanged) ---
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-chat-btn');
        const historyDiv = document.getElementById('chat-history');
        const startBtn = document.getElementById('start-interview-btn');
        
        startBtn.addEventListener('click', async () => {
            const mode = document.getElementById('interview-mode').value;
            historyDiv.innerHTML = '';
            
            chatInput.disabled = false;
            sendBtn.disabled = false;
            startBtn.disabled = true;
            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            startBtn.textContent = "Interview in Progress...";

            addMessage("AI", `Starting ${mode} Interview... connecting...`);
            
            const prompt = `You are a professional and polite ${mode} interviewer for a ${userProfile.targetRole} role. 
            Start the interview by introducing yourself briefly and asking the first relevant question.`;
            
            const reply = await callGemini(prompt);
            
            // Remove "Connecting..." and show real msg
            historyDiv.innerHTML = ''; 
            addMessage("AI", reply);
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text) return;

            addMessage("You", text);
            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;

            // Simple context: Last response + Current Answer
            // In production, you'd send full history.
            const prompt = `I am a candidate for ${userProfile.targetRole}. Here is my answer to your previous question: "${text}". 
            Evaluate it briefly (one sentence feedback) and then ask the next follow-up question. Be encouraging but professional.`;
            
            const reply = await callGemini(prompt);
            addMessage("AI", reply);
            
            chatInput.disabled = false;
            sendBtn.disabled = false;
            chatInput.focus();
        });

        function addMessage(sender, text) {
            const isUser = sender === "You";
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isUser ? 'chat-user' : 'chat-ai'} animate-fadeIn`;
            
            const content = isUser ? text : marked.parse(text);
            
            bubble.innerHTML = content;
            historyDiv.appendChild(bubble);
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        // --- 7. TEST SERIES LOGIC (Unchanged) ---
        
        window.startLevelTest = async function(level, type) {
            document.getElementById('level-selection-area').classList.add('hidden');
            document.getElementById('level-test-area').classList.remove('hidden');
            document.getElementById('level-test-questions').classList.add('hidden');
            document.getElementById('level-test-results').classList.add('hidden');
            document.getElementById('level-test-loading').classList.remove('hidden');

            document.getElementById('loading-level').textContent = `${level} (${type})`;
            document.getElementById('loading-role').textContent = userProfile.targetRole;
            
            const prompt = `Generate 5 multiple choice questions (JSON format) for a ${type} test for a ${userProfile.targetRole} role. 
            Output array of objects with 'question', 'options' (array of 4 strings), and 'correctIndex' (0-3). 
            Output ONLY valid JSON array. No code blocks.`;

            const result = await callGemini(prompt);
            
            document.getElementById('level-test-loading').classList.add('hidden');

            if (result) {
                try {
                    const jsonStr = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    activeTestQuestions = JSON.parse(jsonStr);
                    renderLevelQuestions(level);
                } catch (e) {
                    console.error("JSON Parse error", e);
                    document.getElementById('level-test-area').innerHTML = '<div class="text-center p-4 bg-red-50 text-red-600 rounded-lg">Failed to load test. AI response error.</div>';
                }
            } else {
                 document.getElementById('level-test-area').innerHTML = '<div class="text-center p-4 bg-red-50 text-red-600 rounded-lg">Failed to load test. Network or API error.</div>';
            }
        }

        function renderLevelQuestions(level) {
            const container = document.getElementById('level-test-questions');
            container.innerHTML = `
                <h3 class="text-2xl font-bold text-slate-800 font-heading mb-6">${level} Test: ${userProfile.targetRole}</h3>
                <form id="level-test-form" class="space-y-6">
                ${activeTestQuestions.map((q, i) => `
                    <div class="p-6 bg-slate-50 rounded-xl border border-slate-200 shadow-sm transition hover:shadow-md">
                        <p class="font-bold text-slate-800 mb-4 text-lg"><span class="text-primary mr-2">Q${i+1}.</span> ${q.question}</p>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 p-4 bg-white rounded-lg border border-slate-200 cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition group">
                                <input type="radio" name="q${i}" value="0" class="w-5 h-5 text-primary border-slate-300 focus:ring-primary" required>
                                <span class="text-slate-700 font-medium group-hover:text-primary">${q.options[0]}</span>
                            </label>
                            <label class="flex items-center gap-3 p-4 bg-white rounded-lg border border-slate-200 cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition group">
                                <input type="radio" name="q${i}" value="1" class="w-5 h-5 text-primary border-slate-300 focus:ring-primary">
                                <span class="text-slate-700 font-medium group-hover:text-primary">${q.options[1]}</span>
                            </label>
                            <label class="flex items-center gap-3 p-4 bg-white rounded-lg border border-slate-200 cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition group">
                                <input type="radio" name="q${i}" value="2" class="w-5 h-5 text-primary border-slate-300 focus:ring-primary">
                                <span class="text-slate-700 font-medium group-hover:text-primary">${q.options[2]}</span>
                            </label>
                            <label class="flex items-center gap-3 p-4 bg-white rounded-lg border border-slate-200 cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition group">
                                <input type="radio" name="q${i}" value="3" class="w-5 h-5 text-primary border-slate-300 focus:ring-primary">
                                <span class="text-slate-700 font-medium group-hover:text-primary">${q.options[3]}</span>
                            </label>
                        </div>
                    </div>
                `).join('')}
                    <button type="submit" id="submit-level-test-btn" class="w-full bg-primary text-white font-bold py-4 rounded-xl hover:bg-indigo-700 transition shadow-lg mt-4 text-lg">
                        Submit Test & Get Feedback
                    </button>
                </form>
            `;
            container.classList.remove('hidden');

            document.getElementById('level-test-form').addEventListener('submit', submitLevelTest);
        }

        async function submitLevelTest(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-level-test-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Grading & Analyzing...';
            btn.disabled = true;

            let correctCount = 0;
            let incorrectDetails = [];
            
            // 1. Grade the test
            activeTestQuestions.forEach((q, i) => {
                const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
                const userAnswer = selectedOption ? parseInt(selectedOption.value) : -1;
                const isCorrect = userAnswer === q.correctIndex;
                
                if (isCorrect) {
                    correctCount++;
                } else {
                    incorrectDetails.push({
                        question: q.question,
                        userAnswerIndex: userAnswer,
                        correctAnswer: q.options[q.correctIndex]
                    });
                }
            });

            // 2. Prepare Feedback Prompt
            const totalQuestions = activeTestQuestions.length;
            const score = correctCount;
            let incorrectTopics = incorrectDetails.map(d => d.question).join(" | ");
            
            let feedbackPrompt = `A candidate for a ${userProfile.targetRole} role just scored ${score} out of ${totalQuestions} on a skill test. 
            The candidate incorrectly answered questions related to: [${incorrectTopics}]. 
            
            Generate a detailed analysis (2-3 paragraphs) in Markdown for the candidate:
            1. An encouraging opening statement with the final score.
            2. A brief analysis of the incorrect topics.
            3. A short, actionable tip on how to improve in the areas they struggled with, tailored to their role.
            
            Output ONLY the Markdown content.`;

            // 3. Call Gemini for detailed feedback
            const feedback = await callGemini(feedbackPrompt);
            
            // 4. Render Results
            document.getElementById('level-test-questions').classList.add('hidden');
            document.getElementById('level-test-results').classList.remove('hidden');

            const resultsHeading = document.getElementById('results-heading');
            resultsHeading.innerHTML = `Your Score: <span class="text-primary">${score}/${totalQuestions}</span>`;

            // Set the border color of the feedback box based on performance
            const feedbackBox = document.querySelector('#level-test-results .border-t-4');
            const feedbackBorder = document.querySelector('#level-test-results .w-1');
            
            // Reset existing classes
            feedbackBox.classList.remove('border-red-500', 'border-green-500');
            feedbackBorder.classList.remove('bg-red-500', 'bg-green-500');

            if (score / totalQuestions > 0.6) {
                feedbackBox.classList.add('border-green-500');
                feedbackBorder.classList.add('bg-green-500');
            } else {
                feedbackBox.classList.add('border-red-500');
                feedbackBorder.classList.add('bg-red-500');
            }

            document.getElementById('results-feedback-text').innerHTML = marked.parse(feedback || "Could not generate AI feedback. Please review the topics you missed.");
            
            btn.disabled = false;
        }

        // --- LOGOUT / RESET ---
        document.getElementById('logout-btn').addEventListener('click', () => {
            if(confirm("This will clear your local progress and reset the app. Continue?")) {
                localStorage.removeItem('cracknest_profile');
                localStorage.clear(); 
                window.location.href = "index.html"; // Should redirect to an index page or reload
            }
        });

        // --- MOBILE MENU ---
        document.getElementById('mobile-menu-toggle').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.remove('hidden');
        });
        document.getElementById('close-mobile-menu').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.add('hidden');
        });

        // Start App
        initApp();

    </script>
</body>
</html>
